<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwiftData Admin - Control Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkBg: '#0f172a',
                        darkCard: '#1e293b',
                        darkBorder: '#334155'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0, 0, 0, 0.05); }
        .dark .glass { background: rgba(15, 23, 42, 0.9); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .card { @apply bg-white dark:bg-darkCard border border-slate-100 dark:border-darkBorder rounded-[2rem] p-6 shadow-sm; }
        input, select { @apply w-full p-4 bg-slate-50 dark:bg-slate-800 dark:text-white rounded-2xl outline-none focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/20 transition-all font-bold; }
        .btn-primary { @apply bg-blue-600 text-white px-6 py-4 rounded-2xl font-extrabold hover:bg-blue-700 transition-all flex items-center justify-center gap-2; }
    </style>
</head>
<body class="bg-[#f8fafc] dark:bg-darkBg text-slate-900 dark:text-slate-100 min-h-screen">

    <div id="auth-screen" class="hidden fixed inset-0 z-50 bg-white dark:bg-darkBg flex items-center justify-center p-6">
        <div class="max-w-md w-full space-y-8 text-center">
            <div class="inline-flex w-20 h-20 bg-blue-600 rounded-[2rem] items-center justify-center shadow-2xl shadow-blue-200 mb-4">
                <i data-lucide="shield-check" class="text-white w-10 h-10"></i>
            </div>
            <h1 class="text-4xl font-extrabold tracking-tight">Admin Login</h1>
            <div class="space-y-4">
                <input type="email" id="adminEmail" placeholder="Admin Email">
                <input type="password" id="adminPass" placeholder="Password">
                <button onclick="handleLogin()" class="w-full btn-primary">Authorize Access</button>
            </div>
        </div>
    </div>

    <div id="admin-app" class="hidden">
        <nav class="glass sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-slate-900 dark:bg-blue-600 rounded-xl flex items-center justify-center">
                        <i data-lucide="settings" class="text-white w-6 h-6"></i>
                    </div>
                    <span class="font-extrabold text-xl tracking-tight">SwiftData <span class="text-blue-600">Admin</span></span>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="toggleTheme()" class="p-3 rounded-xl bg-slate-100 dark:bg-slate-800"><i data-lucide="moon" id="theme-icon" class="w-5 h-5"></i></button>
                    <button onclick="handleLogout()" class="text-red-500 font-bold text-sm">Logout</button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-6 py-10 grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-3 space-y-2">
                <button onclick="switchTab('dash')" class="tab-btn w-full text-left p-4 rounded-2xl font-bold flex items-center gap-3 bg-blue-600 text-white" id="tab-dash">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
                </button>
                <button onclick="switchTab('orders')" class="tab-btn w-full text-left p-4 rounded-2xl font-bold flex items-center gap-3 hover:bg-slate-100 dark:hover:bg-slate-800" id="tab-orders">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i> Orders <span id="pending-badge" class="ml-auto bg-red-500 text-white text-[10px] px-2 py-1 rounded-full hidden">0</span>
                </button>
                <button onclick="switchTab('products')" class="tab-btn w-full text-left p-4 rounded-2xl font-bold flex items-center gap-3 hover:bg-slate-100 dark:hover:bg-slate-800" id="tab-products">
                    <i data-lucide="package" class="w-5 h-5"></i> Bundles
                </button>
                <button onclick="switchTab('config')" class="tab-btn w-full text-left p-4 rounded-2xl font-bold flex items-center gap-3 hover:bg-slate-100 dark:hover:bg-slate-800" id="tab-config">
                    <i data-lucide="sliders" class="w-5 h-5"></i> System Settings
                </button>
            </div>

            <div class="lg:col-span-9 space-y-8">
                
                <section id="view-dash" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="card bg-blue-600 !text-white">
                            <p class="text-blue-100 font-bold text-sm uppercase">Total Revenue</p>
                            <h2 class="text-4xl font-extrabold mt-2" id="stat-rev">GHS 0.00</h2>
                        </div>
                        <div class="card">
                            <p class="text-slate-400 font-bold text-sm uppercase">Orders Today</p>
                            <h2 class="text-4xl font-extrabold mt-2" id="stat-orders">0</h2>
                        </div>
                        <div class="card">
                            <p class="text-slate-400 font-bold text-sm uppercase">Store Status</p>
                            <div id="stat-status" class="mt-2 text-2xl font-black">---</div>
                        </div>
                    </div>
                </section>

                <section id="view-orders" class="hidden space-y-6">
                    <h2 class="text-2xl font-extrabold">Recent Orders</h2>
                    <div id="orders-container" class="space-y-4">
                        </div>
                </section>

                <section id="view-products" class="hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-extrabold">Data Bundles</h2>
                        <button onclick="toggleProductModal()" class="btn-primary py-2 px-4 text-sm">+ Add Bundle</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="products-list">
                        </div>
                </section>

                <section id="view-config" class="hidden card space-y-8">
                    <div>
                        <h3 class="font-extrabold text-xl mb-4">Store Controls</h3>
                        <div class="flex items-center gap-4 p-6 bg-slate-50 dark:bg-slate-800 rounded-3xl">
                            <div class="flex-grow">
                                <p class="font-bold">Store Open Status</p>
                                <p class="text-xs text-slate-500">When closed, users cannot place orders.</p>
                            </div>
                            <button onclick="toggleStore()" id="store-toggle-btn" class="px-6 py-3 rounded-xl font-black text-xs uppercase tracking-widest transition-all"></button>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h3 class="font-extrabold text-xl">Marquee Announcement</h3>
                        <input type="text" id="ann-text" placeholder="Announcement text...">
                        <button onclick="updateAnnouncement()" class="btn-primary w-full">Update Marquee</button>
                    </div>
                    <div class="space-y-4">
                        <h3 class="font-extrabold text-xl">Payment Gateway (Paystack)</h3>
                        <input type="text" id="conf-pk" placeholder="Public Key (pk_...)">
                        <button onclick="saveKeys()" class="btn-primary w-full">Save API Configuration</button>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <div id="prod-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-6">
        <div class="bg-white dark:bg-darkCard w-full max-w-md p-8 rounded-[2.5rem] space-y-4 shadow-2xl">
            <h3 class="text-2xl font-extrabold">New Bundle</h3>
            <select id="p-net">
                <option value="MTN">MTN</option>
                <option value="Telecel">Telecel</option>
                <option value="AT">AT</option>
            </select>
            <input type="text" id="p-size" placeholder="Bundle Size (e.g. 10GB)">
            <input type="number" id="p-price" placeholder="Price (GHS)">
            <input type="number" id="p-rank" placeholder="Sort Rank (1, 2, 3...)">
            <div class="flex gap-3">
                <button onclick="toggleProductModal()" class="flex-1 p-4 font-bold text-slate-400">Cancel</button>
                <button onclick="saveProduct()" class="flex-1 btn-primary">Create</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, addDoc, deleteDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBVTQqx3fpkpUeCRO5B4N9Hb8dDxJGDIsg",
            authDomain: "swiftdata-32d80.firebaseapp.com",
            projectId: "swiftdata-32d80",
            storageBucket: "swiftdata-32d80.firebasestorage.app",
            messagingSenderId: "112123396026",
            appId: "1:112123396026:web:8673fe7a2e5b77e2156783"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'swiftdata-main-app';

        let state = { orders: [], products: [], settings: {}, announcement: {} };

        // Authentication Flow
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('admin-app').classList.remove('hidden');
                initData();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('admin-app').classList.add('hidden');
            }
        });

        window.handleLogin = async () => {
            const e = document.getElementById('adminEmail').value;
            const p = document.getElementById('adminPass').value;
            try { await signInWithEmailAndPassword(auth, e, p); } 
            catch (err) { alert("Access Denied: " + err.message); }
        };

        window.handleLogout = () => signOut(auth);

        // Data Sync
        function initData() {
            // Orders
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), (snap) => {
                state.orders = snap.docs.map(d => ({ id: d.id, ...d.data() }))
                                    .sort((a,b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                renderOrders();
                calculateStats();
            });

            // Products
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), (snap) => {
                state.products = snap.docs.map(d => ({ id: d.id, ...d.data() }))
                                     .sort((a,b) => a.rank - b.rank);
                renderProducts();
            });

            // Settings
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings_doc'), (d) => {
                if(d.exists()) {
                    state.settings = d.data();
                    renderSettings();
                }
            });

            // Announcement
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'announcement'), (d) => {
                if(d.exists()) state.announcement = d.data();
            });
        }

        // Logic Functions
        window.switchTab = (tab) => {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('bg-blue-600', 'text-white'));
            
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('bg-blue-600', 'text-white');
        };

        function calculateStats() {
            const today = new Date().toLocaleDateString();
            const todayOrders = state.orders.filter(o => o.createdAt?.toDate().toLocaleDateString() === today);
            const revenue = state.orders.filter(o => o.status === 'delivered').reduce((acc, curr) => acc + parseFloat(curr.price || 0), 0);
            const pending = state.orders.filter(o => o.status === 'pending').length;

            document.getElementById('stat-rev').innerText = `GHS ${revenue.toFixed(2)}`;
            document.getElementById('stat-orders').innerText = todayOrders.length;
            
            const badge = document.getElementById('pending-badge');
            if(pending > 0) { badge.innerText = pending; badge.classList.remove('hidden'); }
            else { badge.classList.add('hidden'); }
        }

        function renderOrders() {
            const container = document.getElementById('orders-container');
            container.innerHTML = state.orders.map(o => `
                <div class="card flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="px-2 py-0.5 bg-slate-100 dark:bg-slate-800 rounded text-[10px] font-black uppercase tracking-tighter">${o.method || 'paystack'}</span>
                            <span class="text-[10px] text-slate-400 font-bold">${o.createdAt?.toDate().toLocaleString() || 'Pending...'}</span>
                        </div>
                        <h4 class="text-lg font-extrabold">${o.network} ${o.bundleSize} â†’ <span class="text-blue-600">${o.recipientPhone}</span></h4>
                        <p class="text-xs font-bold text-slate-500">${o.method === 'momo' ? `Sender: ${o.senderName} | TID: ${o.transId}` : `Ref: ${o.paystackRef || 'N/A'}`}</p>
                    </div>
                    <div class="flex gap-2 w-full md:w-auto">
                        <select onchange="updateStatus('${o.id}', this.value)" class="!p-2 !text-xs !w-auto border border-slate-200">
                            <option value="pending" ${o.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="processing" ${o.status === 'processing' ? 'selected' : ''}>Processing</option>
                            <option value="delivered" ${o.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                        </select>
                        <button onclick="deleteOrder('${o.id}')" class="p-2 text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            `).join('');
            if(window.lucide) lucide.createIcons();
        }

        window.updateStatus = async (id, status) => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), { status });
        };

        window.deleteOrder = async (id) => {
            if(confirm("Delete this order record?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id));
        };

        function renderProducts() {
            const container = document.getElementById('products-list');
            container.innerHTML = state.products.map(p => `
                <div class="card flex justify-between items-center border-l-4 ${p.network === 'MTN' ? 'border-yellow-400' : 'border-blue-600'}">
                    <div>
                        <p class="text-[10px] font-black opacity-50 uppercase">${p.network}</p>
                        <h4 class="font-extrabold text-xl">${p.size}</h4>
                        <p class="text-blue-600 font-bold">GHS ${p.price}</p>
                    </div>
                    <button onclick="deleteProduct('${p.id}')" class="w-10 h-10 flex items-center justify-center text-red-500 hover:bg-red-50 rounded-full transition-all">
                        <i data-lucide="trash" class="w-5 h-5"></i>
                    </button>
                </div>
            `).join('');
            if(window.lucide) lucide.createIcons();
        }

        window.toggleProductModal = () => document.getElementById('prod-modal').classList.toggle('hidden');

        window.saveProduct = async () => {
            const data = {
                network: document.getElementById('p-net').value,
                size: document.getElementById('p-size').value,
                price: parseFloat(document.getElementById('p-price').value),
                rank: parseInt(document.getElementById('p-rank').value) || 0
            };
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), data);
            toggleProductModal();
        };

        window.deleteProduct = async (id) => {
            if(confirm("Delete this bundle?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id));
        };

        function renderSettings() {
            const btn = document.getElementById('store-toggle-btn');
            const stat = document.getElementById('stat-status');
            
            if(state.settings.storeOpen) {
                btn.className = "px-6 py-3 rounded-xl font-black text-xs uppercase bg-red-100 text-red-600";
                btn.innerText = "Close Store";
                stat.innerHTML = `<span class="text-green-500 flex items-center gap-2"><div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div> Open</span>`;
            } else {
                btn.className = "px-6 py-3 rounded-xl font-black text-xs uppercase bg-green-600 text-white";
                btn.innerText = "Open Store";
                stat.innerHTML = `<span class="text-red-500 flex items-center gap-2">Offline</span>`;
            }

            document.getElementById('conf-pk').value = state.settings.paystackPublicKey || '';
            document.getElementById('ann-text').value = state.announcement.text || '';
        }

        window.toggleStore = async () => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings_doc'), {
                storeOpen: !state.settings.storeOpen
            });
        };

        window.updateAnnouncement = async () => {
            const text = document.getElementById('ann-text').value;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'announcement'), {
                text: text,
                active: text.length > 0
            });
            alert("Marquee updated!");
        };

        window.saveKeys = async () => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings_doc'), {
                paystackPublicKey: document.getElementById('conf-pk').value
            });
            alert("API Keys updated!");
        };

        window.toggleTheme = () => {
            const html = document.documentElement;
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            document.getElementById('theme-icon').setAttribute('data-lucide', isDark ? 'sun' : 'moon');
            lucide.createIcons();
        };

        if(window.lucide) lucide.createIcons();
    </script>
</body>
</html>
