<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Agent Dashboard ‚Äî SwiftData GH</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<style>
:root{--blue:#0051ff;--mint:#00e5b0;--yellow:#f59e0b;--green:#22c55e;--red:#ef4444;}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Plus Jakarta Sans',sans-serif;background:#060b18;color:#fff;min-height:100vh;}
.gate{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem;}
.gate-box{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:28px;padding:3rem;max-width:420px;width:100%;text-align:center;animation:fadeUp .4s ease;}
.gate-box h1{font-weight:800;font-size:1.6rem;margin-bottom:.35rem;}
.gate-box p{font-size:.85rem;color:rgba(255,255,255,.3);margin-bottom:1.5rem;line-height:1.6;}
.spin{width:24px;height:24px;border:2.5px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:sp .7s linear infinite;}
@keyframes sp{to{transform:rotate(360deg);}}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);}}
.gate-err{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);color:#fca5a5;padding:1rem;border-radius:12px;margin-bottom:1rem;font-size:.85rem;line-height:1.6;display:none;}
.gate-btn{width:100%;padding:.9rem;background:var(--blue);color:#fff;border:none;border-radius:12px;font-family:inherit;font-weight:800;font-size:.95rem;cursor:pointer;display:none;}
.dashboard{display:none;}
.sidebar{width:240px;position:fixed;top:0;left:0;bottom:0;background:#0a0f1e;border-right:1px solid rgba(255,255,255,.06);display:flex;flex-direction:column;}
.sb-logo{padding:1.5rem;border-bottom:1px solid rgba(255,255,255,.06);font-weight:800;font-size:1.05rem;}
.sb-logo span{color:var(--mint);}
.sb-nav{flex:1;padding:1rem 0;}
.sb-btn{display:flex;align-items:center;gap:.65rem;padding:.6rem 1.2rem;color:rgba(255,255,255,.35);border:none;background:none;font-family:inherit;font-size:.82rem;font-weight:700;cursor:pointer;width:100%;border-left:3px solid transparent;transition:all .2s;}
.sb-btn:hover{color:#fff;background:rgba(255,255,255,.04);}
.sb-btn.active{color:#fff;background:rgba(0,81,255,.1);border-left-color:var(--blue);}
.sb-foot{padding:1.2rem;border-top:1px solid rgba(255,255,255,.06);}
.logout-btn{background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);color:#fca5a5;padding:.5rem 1rem;border-radius:10px;font-family:inherit;font-weight:700;font-size:.8rem;cursor:pointer;width:100%;transition:all .2s;}
.main{margin-left:240px;min-height:100vh;}
.topbar{height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 2rem;border-bottom:1px solid rgba(255,255,255,.06);}
.topbar h1{font-weight:800;font-size:1.15rem;}
.content{padding:2rem;}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:2rem;}
.stat-card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:16px;padding:1.25rem;}
.stat-lbl{font-size:.65rem;text-transform:uppercase;letter-spacing:1.5px;color:rgba(255,255,255,.25);margin-bottom:.5rem;}
.stat-val{font-weight:800;font-size:1.6rem;color:var(--mint);}
.panel{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06);border-radius:16px;overflow:hidden;margin-bottom:1.5rem;}
.panel-head{padding:1rem 1.5rem;border-bottom:1px solid rgba(255,255,255,.05);}
.panel-head h3{font-weight:800;font-size:.95rem;}
.btn{padding:.5rem 1rem;background:var(--blue);color:#fff;border:none;border-radius:10px;font-family:inherit;font-weight:700;font-size:.8rem;cursor:pointer;transition:all .2s;margin-top:1rem;}
.btn:hover{opacity:.9;}
.empty{padding:2rem;text-align:center;color:rgba(255,255,255,.15);font-weight:700;text-transform:uppercase;letter-spacing:2px;font-size:.75rem;}
</style>
</head>
<body>

<!-- GATE (Loading Screen) -->
<div class="gate" id="gate">
  <div class="gate-box">
    <div style="font-size:2.5rem;margin-bottom:1rem;">üîê</div>
    <h1>Loading Dashboard</h1>
    <p>Verifying your account...</p>
    <div style="margin:2rem 0;"><div class="spin"></div></div>
    <div id="gate-err" class="gate-err"></div>
    <button id="gate-retry" class="gate-btn" onclick="location.reload()">Try Again</button>
  </div>
</div>

<!-- DASHBOARD -->
<div class="dashboard" id="dashboard">
  <aside class="sidebar">
    <div class="sb-logo">SwiftData<span>GH</span></div>
    <nav class="sb-nav">
      <button class="sb-btn active" onclick="switchTab('overview')"><span>üìä</span><span>Dashboard</span></button>
      <button class="sb-btn" onclick="switchTab('products')"><span>üì¶</span><span>Products</span></button>
      <button class="sb-btn" onclick="switchTab('orders')"><span>üîÑ</span><span>Orders</span></button>
      <button class="sb-btn" onclick="switchTab('wallet')"><span>üí∞</span><span>Wallet</span></button>
    </nav>
    <div class="sb-foot">
      <button class="logout-btn" onclick="handleLogout()">‚Ü™ Logout</button>
    </div>
  </aside>

  <div class="main">
    <div class="topbar">
      <div><h1 id="tab-title">Dashboard</h1></div>
      <div id="agent-info" style="font-size:.85rem;color:rgba(255,255,255,.5);"></div>
    </div>

    <div class="content">
      <!-- OVERVIEW -->
      <div id="tab-overview">
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-lbl">Wallet</div><div class="stat-val" id="s-wallet">GHS 0.00</div></div>
          <div class="stat-card"><div class="stat-lbl">Earned</div><div class="stat-val" id="s-earned">GHS 0.00</div></div>
          <div class="stat-card"><div class="stat-lbl">Orders</div><div class="stat-val" id="s-orders">0</div></div>
          <div class="stat-card"><div class="stat-lbl">Status</div><div class="stat-val" id="s-status">‚Äî</div></div>
        </div>

        <div class="panel">
          <div class="panel-head">
            <h3>Your Store Link</h3>
            <button class="btn" onclick="copyLink()">üìã Copy</button>
          </div>
          <div style="padding:1.5rem;font-family:monospace;font-size:.85rem;color:var(--blue);word-break:break-all;">
            <span id="store-link">https://yoursite.com/store?agent=username</span>
          </div>
        </div>
      </div>

      <!-- PRODUCTS -->
      <div id="tab-products" class="hidden">
        <div class="panel">
          <div class="panel-head">
            <h3>Your Products</h3>
            <button class="btn" onclick="alert('Add from base products modal')">+ Add</button>
          </div>
          <div id="products-list"><div class="empty"><div class="spin" style="margin:0 auto;"></div></div></div>
        </div>
      </div>

      <!-- ORDERS -->
      <div id="tab-orders" class="hidden">
        <div class="panel">
          <div class="panel-head"><h3>Your Orders</h3></div>
          <div id="orders-list"><div class="empty"><div class="spin" style="margin:0 auto;"></div></div></div>
        </div>
      </div>

      <!-- WALLET -->
      <div id="tab-wallet" class="hidden">
        <div class="panel">
          <div class="panel-head"><h3>Wallet</h3></div>
          <div style="padding:1.5rem;">
            <div><div style="font-size:.75rem;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:.5rem;">Balance</div>
            <div style="font-weight:800;font-size:2rem;color:var(--mint);" id="wallet-bal">GHS 0.00</div></div>
            <button class="btn" onclick="alert('Request cashout')">üí∏ Request Cashout</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCs7lN4itvWZPichtFLdEE4swNQHSX_j1M",
  authDomain: "dataplus-a93c7.firebaseapp.com",
  projectId: "dataplus-a93c7",
  storageBucket: "dataplus-a93c7.firebasestorage.app",
  messagingSenderId: "1040979049946",
  appId: "1:1040979049946:web:d5d7957a6c209f56dd94e3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let S = {agent: null, products: [], orders: []};

window.switchTab = (tab) => {
  ['overview', 'products', 'orders', 'wallet'].forEach(t => {
    const el = document.getElementById(`tab-${t}`);
    if (el) el.classList.toggle('hidden', t !== tab);
  });
  document.querySelectorAll('.sb-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('tab-title').textContent = {overview: 'Dashboard', products: 'Products', orders: 'Orders', wallet: 'Wallet'}[tab] || 'Dashboard';
};

window.copyLink = () => {
  navigator.clipboard.writeText(document.getElementById('store-link').textContent).then(() => alert('Link copied!'));
};

window.handleLogout = async () => {
  try {
    await signOut(auth);
    window.location.href = '/agent.login';
  } catch (e) {
    alert('Logout error: ' + e.message);
  }
};

function updateStats() {
  if (!S.agent) return;
  document.getElementById('s-wallet').textContent = 'GHS ' + (S.agent.walletBalance || 0).toFixed(2);
  document.getElementById('s-earned').textContent = 'GHS ' + (S.agent.totalEarned || 0).toFixed(2);
  document.getElementById('s-orders').textContent = S.agent.totalOrders || 0;
  document.getElementById('s-status').textContent = (S.agent.status || 'unknown').toUpperCase();
  document.getElementById('wallet-bal').textContent = 'GHS ' + (S.agent.walletBalance || 0).toFixed(2);
  document.getElementById('agent-info').textContent = `@${S.agent.username}`;
  document.getElementById('store-link').textContent = `${window.location.origin}/store?agent=${S.agent.username}`;
}

// ‚úÖ PROPER AUTH HANDLING - NO AUTO-LOGOUT
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    // User not logged in - show gate
    document.getElementById('gate').style.display = 'flex';
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('gate-err').textContent = 'Please log in first.';
    document.getElementById('gate-err').style.display = 'block';
    document.getElementById('gate-retry').style.display = 'block';
    return;
  }

  try {
    console.log('Auth user:', user.uid);
    
    // ‚úÖ Fetch agent doc - THIS IS THE CRITICAL PART
    const agentRef = doc(db, 'swiftdata_agents', user.uid);
    const agentSnap = await getDoc(agentRef);

    if (!agentSnap.exists()) {
      throw new Error('Agent account not found. Please contact support.');
    }

    S.agent = {uid: user.uid, ...agentSnap.data()};
    console.log('Agent loaded:', S.agent.username);

    // Show dashboard
    document.getElementById('gate').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';

    updateStats();

    // ‚úÖ Set up listeners with error handlers
    onSnapshot(
      collection(db, 'swiftdata_agents', user.uid, 'products'),
      (snap) => {
        S.products = snap.docs.map(d => ({id: d.id, ...d.data()}));
        const list = document.getElementById('products-list');
        if (!S.products.length) {
          list.innerHTML = '<div class="empty">No products yet.</div>';
        } else {
          list.innerHTML = S.products.map(p => `<div style="padding:1rem;border-bottom:1px solid rgba(255,255,255,.05);">
            <div style="font-weight:700;">${p.size} (${p.network})</div>
            <div style="font-size:.78rem;color:rgba(255,255,255,.3);">+GHS ${p.markup.toFixed(2)} markup</div>
          </div>`).join('');
        }
      },
      (err) => console.error('Products listener error:', err)
    );

    onSnapshot(
      collection(db, 'orders'),
      (snap) => {
        S.orders = snap.docs.filter(d => d.data().agentId === user.uid).map(d => ({id: d.id, ...d.data()}));
        const list = document.getElementById('orders-list');
        if (!S.orders.length) {
          list.innerHTML = '<div class="empty">No orders yet.</div>';
        } else {
          list.innerHTML = S.orders.slice(0, 10).map(o => `<div style="padding:1rem;border-bottom:1px solid rgba(255,255,255,.05);">
            <div style="display:flex;justify-content:space-between;margin-bottom:.25rem;">
              <span style="font-weight:700;">${o.size} (${o.network})</span>
              <span style="font-size:.75rem;padding:.2rem .6rem;border-radius:50px;background:rgba(0,81,255,.2);color:var(--blue);">${o.status}</span>
            </div>
            <div style="font-size:.78rem;color:rgba(255,255,255,.4);">Ref: ${o.orderRef}</div>
          </div>`).join('');
        }
        updateStats();
      },
      (err) => console.error('Orders listener error:', err)
    );

  } catch (error) {
    console.error('Auth setup error:', error.code, error.message);
    
    // Show error - NOT logout
    document.getElementById('gate').style.display = 'flex';
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('gate-err').textContent = '‚ö† ' + error.message;
    document.getElementById('gate-err').style.display = 'block';
    document.getElementById('gate-retry').style.display = 'block';
  }
});
</script>
</body>
</html>
