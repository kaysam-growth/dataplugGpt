<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Agent Dashboard ‚Äî SwiftData GH</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<script src="https://js.paystack.co/v2/inline.js"></script>
<style>
:root{--blue:#0051ff;--sky:#38bdf8;--mint:#00e5b0;--yellow:#f59e0b;--green:#22c55e;--red:#ef4444;}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Plus Jakarta Sans',sans-serif;background:#060b18;color:#fff;min-height:100vh;display:flex;}
/* SIDEBAR */
.sidebar{width:230px;flex-shrink:0;background:#0a0f1e;border-right:1px solid rgba(255,255,255,.06);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:50;}
.sb-brand{padding:1.5rem;border-bottom:1px solid rgba(255,255,255,.06);}
.sb-logo{font-weight:800;font-size:1.1rem;color:#fff;letter-spacing:-.3px;}
.sb-logo span{color:var(--mint);}
.sb-agent-name{font-size:.78rem;color:rgba(255,255,255,.3);margin-top:.3rem;font-weight:500;}
.sb-nav{flex:1;padding:1rem 0;overflow-y:auto;}
.sb-sec{font-size:.65rem;font-weight:800;text-transform:uppercase;letter-spacing:2px;color:rgba(255,255,255,.18);padding:.5rem 1.25rem;margin-top:.5rem;}
.sb-btn{display:flex;align-items:center;gap:.7rem;padding:.68rem 1.25rem;color:rgba(255,255,255,.4);border:none;background:none;font-family:inherit;font-size:.88rem;font-weight:600;cursor:pointer;width:100%;text-align:left;border-left:3px solid transparent;transition:all .2s;}
.sb-btn:hover{color:#fff;background:rgba(255,255,255,.04);}
.sb-btn.active{color:#fff;background:rgba(0,81,255,.1);border-left-color:var(--blue);}
.sb-icon{width:18px;text-align:center;flex-shrink:0;}
.sb-footer{padding:1.25rem;border-top:1px solid rgba(255,255,255,.06);}
.sb-user-row{display:flex;align-items:center;gap:.65rem;}
.sb-avatar{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--blue),var(--sky));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.85rem;flex-shrink:0;}
.sb-uname{font-size:.82rem;font-weight:700;color:#fff;}
.sb-email{font-size:.7rem;color:rgba(255,255,255,.3);}
.logout-btn{background:none;border:none;color:rgba(255,255,255,.25);cursor:pointer;font-size:.85rem;margin-left:auto;transition:color .2s;}
.logout-btn:hover{color:var(--red);}
/* MAIN */
.main{flex:1;margin-left:230px;min-height:100vh;display:flex;flex-direction:column;}
.top-bar{height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 2.5rem;border-bottom:1px solid rgba(255,255,255,.06);background:rgba(10,15,30,.95);position:sticky;top:0;z-index:40;}
.top-title{font-weight:800;font-size:1.2rem;}
.top-right{display:flex;align-items:center;gap:.85rem;}
.store-link-chip{background:rgba(0,229,176,.08);border:1px solid rgba(0,229,176,.18);color:var(--mint);padding:.35rem .9rem;border-radius:50px;font-size:.75rem;font-weight:700;cursor:pointer;transition:all .2s;}
.store-link-chip:hover{background:rgba(0,229,176,.14);}
.content{flex:1;padding:2rem 2.5rem;}
/* CARDS */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.1rem;margin-bottom:2rem;}
.stat-card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:16px;padding:1.4rem;}
.stat-lbl{font-size:.68rem;text-transform:uppercase;letter-spacing:1.5px;color:rgba(255,255,255,.3);margin-bottom:.5rem;}
.stat-val{font-weight:800;font-size:1.8rem;}
.stat-sub{font-size:.75rem;color:rgba(255,255,255,.3);margin-top:.3rem;}
/* WALLET CARD */
.wallet-card{background:linear-gradient(135deg,#0f2060 0%,#0a1040 50%,#0f1a3a 100%);border:1px solid rgba(0,81,255,.2);border-radius:20px;padding:2rem;margin-bottom:2rem;position:relative;overflow:hidden;}
.wallet-card::before{content:'';position:absolute;top:-40px;right:-40px;width:180px;height:180px;border-radius:50%;background:radial-gradient(circle,rgba(0,229,176,.07) 0%,transparent 70%);}
.wallet-lbl{font-size:.7rem;text-transform:uppercase;letter-spacing:2px;color:rgba(255,255,255,.35);margin-bottom:.5rem;}
.wallet-bal{font-weight:800;font-size:2.5rem;color:var(--mint);letter-spacing:-.5px;}
.wallet-sub{font-size:.82rem;color:rgba(255,255,255,.3);margin-top:.3rem;}
.wallet-row{display:flex;flex-wrap:wrap;align-items:flex-end;justify-content:space-between;gap:1rem;}
.cashout-btn{background:var(--mint);color:#0a1020;border:none;padding:.75rem 1.75rem;border-radius:12px;font-family:inherit;font-weight:800;font-size:.88rem;cursor:pointer;transition:transform .2s,box-shadow .2s;}
.cashout-btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,229,176,.35);}
.cashout-btn:disabled{opacity:.4;cursor:not-allowed;}
.cashout-hint{font-size:.75rem;color:rgba(255,255,255,.2);margin-top:.3rem;}
/* TABS */
.page-tabs{display:flex;background:rgba(255,255,255,.04);border-radius:12px;padding:3px;margin-bottom:1.75rem;width:fit-content;}
.page-tab{padding:.5rem 1.25rem;border-radius:10px;border:none;background:none;color:rgba(255,255,255,.35);font-family:inherit;font-weight:700;font-size:.85rem;cursor:pointer;transition:all .2s;}
.page-tab.active{background:var(--blue);color:#fff;box-shadow:0 4px 12px rgba(0,81,255,.35);}
/* PANEL */
.panel{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06);border-radius:16px;overflow:hidden;margin-bottom:1.5rem;}
.panel-head{padding:1.1rem 1.5rem;border-bottom:1px solid rgba(255,255,255,.05);display:flex;align-items:center;justify-content:space-between;}
.panel-head h3{font-weight:800;font-size:.95rem;}
.add-product-btn{background:var(--blue);color:#fff;border:none;padding:.5rem 1.1rem;border-radius:10px;font-family:inherit;font-weight:700;font-size:.82rem;cursor:pointer;transition:box-shadow .2s;}
.add-product-btn:hover{box-shadow:0 6px 18px rgba(0,81,255,.35);}
/* PRODUCT ROWS */
.prod-row{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:1rem;padding:1.1rem 1.5rem;border-bottom:1px solid rgba(255,255,255,.04);transition:background .15s;}
.prod-row:last-child{border-bottom:none;}
.prod-row:hover{background:rgba(255,255,255,.02);}
.prod-info .pnet{font-size:.68rem;font-weight:700;background:rgba(255,255,255,.06);color:rgba(255,255,255,.5);padding:.18rem .55rem;border-radius:6px;}
.prod-info .psize{font-weight:800;font-size:1.1rem;margin:.2rem 0;}
.prod-info .ptype{font-size:.72rem;color:rgba(255,255,255,.3);}
.prod-prices{display:flex;flex-direction:column;align-items:flex-end;gap:.2rem;}
.price-row{display:flex;gap:.6rem;align-items:center;font-size:.8rem;}
.price-label{color:rgba(255,255,255,.3);}
.agent-cost{color:rgba(255,255,255,.5);font-weight:600;}
.store-price{color:var(--mint);font-weight:800;}
.profit-badge{background:rgba(0,229,176,.1);border:1px solid rgba(0,229,176,.2);color:var(--mint);font-size:.7rem;font-weight:700;padding:.15rem .55rem;border-radius:6px;}
.edit-prod-btn{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);color:rgba(255,255,255,.5);padding:.4rem .8rem;border-radius:8px;font-family:inherit;font-size:.78rem;cursor:pointer;transition:all .2s;}
.edit-prod-btn:hover{background:rgba(255,255,255,.1);color:#fff;}
.toggle-btn{padding:.4rem .8rem;border-radius:8px;font-family:inherit;font-size:.75rem;font-weight:700;cursor:pointer;border:none;transition:all .2s;}
.toggle-btn.visible{background:rgba(34,197,94,.1);color:var(--green);}
.toggle-btn.hidden{background:rgba(255,255,255,.05);color:rgba(255,255,255,.3);}
/* ORDER ROWS */
.order-row{padding:1.1rem 1.5rem;border-bottom:1px solid rgba(255,255,255,.04);}
.order-row:last-child{border-bottom:none;}
.o-top{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:.5rem;margin-bottom:.4rem;}
.o-bundle{font-weight:800;color:var(--blue);}
.o-status{font-size:.72rem;font-weight:700;padding:.22rem .7rem;border-radius:50px;color:#fff;}
.s-Pending{background:var(--yellow)}.s-Processing{background:var(--blue)}.s-Delivered{background:var(--green)}.s-Failed{background:var(--red)}
.o-phone{font-weight:700;margin:.2rem 0;}
.o-meta{font-size:.75rem;color:rgba(255,255,255,.3);}
.o-profit{font-size:.78rem;color:var(--mint);font-weight:700;}
.empty-state{padding:3rem;text-align:center;color:rgba(255,255,255,.2);font-weight:700;text-transform:uppercase;letter-spacing:2px;font-size:.78rem;}
.error-msg{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);color:#fca5a5;padding:1rem;border-radius:10px;margin-bottom:1rem;}
/* CASHOUT LIST */
.cashout-row{padding:1.1rem 1.5rem;border-bottom:1px solid rgba(255,255,255,.04);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.5rem;}
.cashout-row:last-child{border-bottom:none;}
.cashout-amt{font-weight:800;font-size:1rem;color:var(--mint);}
.cashout-status{font-size:.72rem;font-weight:700;padding:.22rem .7rem;border-radius:50px;color:#fff;}
.cs-pending{background:var(--yellow)}.cs-paid{background:var(--green)}.cs-rejected{background:var(--red)}
/* MODALS */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(6px);z-index:200;display:none;align-items:center;justify-content:center;padding:1.5rem;}
.modal-bg.show{display:flex;}
.modal-box{background:#0f172a;border:1px solid rgba(255,255,255,.08);border-radius:22px;padding:2rem;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;}
.modal-title{font-weight:800;font-size:1.15rem;margin-bottom:1.5rem;}
.m-lbl{font-size:.7rem;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:rgba(255,255,255,.3);margin-bottom:.4rem;margin-top:1rem;}
.m-inp{width:100%;padding:.78rem 1rem;background:rgba(255,255,255,.05);border:1.5px solid rgba(255,255,255,.08);border-radius:10px;color:#fff;font-family:inherit;font-size:.9rem;outline:none;transition:border-color .2s;}
.m-inp:focus{border-color:rgba(0,81,255,.5);}
.m-hint{font-size:.72rem;color:rgba(255,255,255,.2);margin-top:.35rem;}
.price-calc{background:rgba(0,229,176,.06);border:1px solid rgba(0,229,176,.12);border-radius:12px;padding:1rem;margin-top:.75rem;}
.price-calc .calc-row{display:flex;justify-content:space-between;font-size:.82rem;color:rgba(255,255,255,.5);margin-bottom:.3rem;}
.price-calc .calc-row strong{color:#fff;}.price-calc .calc-row.profit strong{color:var(--mint);}
.price-calc .calc-total{display:flex;justify-content:space-between;font-weight:800;font-size:.95rem;margin-top:.6rem;padding-top:.6rem;border-top:1px solid rgba(0,229,176,.12);}
.m-btns{display:flex;gap:.75rem;margin-top:1.75rem;}
.m-cancel{flex:1;padding:.8rem;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:10px;color:rgba(255,255,255,.5);font-family:inherit;font-weight:700;cursor:pointer;}
.m-save{flex:1;padding:.8rem;background:var(--blue);border:none;border-radius:10px;color:#fff;font-family:inherit;font-weight:800;cursor:pointer;transition:box-shadow .2s;}
.m-save:hover{box-shadow:0 6px 18px rgba(0,81,255,.35);}
.m-save:disabled{opacity:.4;cursor:not-allowed;}
/* LINK COPY BOX */
.link-copy-box{background:rgba(0,81,255,.06);border:1.5px solid rgba(0,81,255,.15);border-radius:14px;padding:1.1rem 1.25rem;display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;}
.link-url{font-size:.82rem;color:var(--sky);font-weight:600;word-break:break-all;}
.copy-btn{background:rgba(0,81,255,.15);border:1px solid rgba(0,81,255,.25);color:var(--blue);padding:.4rem .9rem;border-radius:8px;font-family:inherit;font-size:.78rem;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap;}
.copy-btn:hover{background:rgba(0,81,255,.25);}
/* SPINNER */
.spin{width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:sp .7s linear infinite;display:inline-block;vertical-align:middle;}
@keyframes sp{to{transform:rotate(360deg);}}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);}}
.content{animation:fadeUp .35s ease;}
/* MOBILE */
@media(max-width:768px){
  .sidebar{width:56px;}.sb-brand .sb-logo span,.sb-brand .sb-agent-name,.sb-btn span:last-child,.sb-sec,.sb-uname,.sb-email{display:none;}
  .sb-btn{justify-content:center;padding:.8rem;}.main{margin-left:56px;}.top-bar{padding:0 1.25rem;}.content{padding:1.25rem;}
  .stats-grid{grid-template-columns:1fr 1fr;}
}
.hidden{display:none!important;}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sb-brand">
    <div class="sb-logo">Swift<span>Data</span></div>
    <div class="sb-agent-name" id="sb-agent-name">Loading‚Ä¶</div>
  </div>
  <nav class="sb-nav">
    <div class="sb-sec">Main</div>
    <button class="sb-btn active" onclick="showTab('overview')"><span class="sb-icon">üìä</span><span>Overview</span></button>
    <button class="sb-btn" onclick="showTab('products')"><span class="sb-icon">üì¶</span><span>My Products</span></button>
    <button class="sb-btn" onclick="showTab('orders')"><span class="sb-icon">üîÑ</span><span>My Orders</span></button>
    <div class="sb-sec">Account</div>
    <button class="sb-btn" onclick="showTab('wallet')"><span class="sb-icon">üí∞</span><span>Wallet & Cashout</span></button>
    <button class="sb-btn" onclick="showTab('store')"><span class="sb-icon">üîó</span><span>My Store Link</span></button>
  </nav>
  <div class="sb-footer">
    <div class="sb-user-row">
      <div class="sb-avatar" id="sb-initials">?</div>
      <div><div class="sb-uname" id="sb-uname-txt">Agent</div><div class="sb-email" id="sb-email-txt"></div></div>
      <button class="logout-btn" onclick="doLogout()" title="Logout">‚úï</button>
    </div>
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="top-bar">
    <div class="top-title" id="top-title">Overview</div>
    <div class="top-right">
      <div class="store-link-chip" onclick="copyStoreLink()" id="store-chip">üìé Copy Store Link</div>
      <a href="/" style="color:rgba(255,255,255,.35);text-decoration:none;font-size:.82rem;">‚Üê Public Store</a>
    </div>
  </div>

  <div class="content">

    <!-- OVERVIEW TAB -->
    <div id="tab-overview">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-lbl">Wallet Balance</div><div class="stat-val" id="stat-wallet" style="color:var(--mint);">GHS 0.00</div><div class="stat-sub">Available to cashout</div></div>
        <div class="stat-card"><div class="stat-lbl">Total Earned</div><div class="stat-val" id="stat-earned" style="color:var(--yellow);">GHS 0.00</div><div class="stat-sub">All time profits</div></div>
        <div class="stat-card"><div class="stat-lbl">Total Orders</div><div class="stat-val" id="stat-orders" style="color:var(--sky);">0</div><div class="stat-sub">Through your store</div></div>
        <div class="stat-card"><div class="stat-lbl">Products Listed</div><div class="stat-val" id="stat-prods" style="color:var(--blue);">0</div><div class="stat-sub">Active in your store</div></div>
      </div>

      <div class="wallet-card">
        <div class="wallet-lbl">Wallet Balance</div>
        <div class="wallet-row">
          <div>
            <div class="wallet-bal" id="wallet-bal">GHS 0.00</div>
            <div class="wallet-sub">Minimum cashout: GHS 5.00</div>
          </div>
          <div>
            <button class="cashout-btn" id="cashout-btn" onclick="openCashoutModal()">Request Cashout</button>
            <div class="cashout-hint" id="cashout-hint"></div>
          </div>
        </div>
      </div>

      <!-- RECENT ORDERS -->
      <div class="panel">
        <div class="panel-head"><h3>Recent Orders</h3><button class="add-product-btn" onclick="showTab('orders')" style="background:rgba(255,255,255,.06);">View All</button></div>
        <div id="recent-orders-list"><div class="empty-state">No orders yet ‚Äî share your store link!</div></div>
      </div>
    </div>

    <!-- PRODUCTS TAB -->
    <div id="tab-products" class="hidden">
      <div class="panel">
        <div class="panel-head">
          <h3>My Store Products</h3>
          <button class="add-product-btn" onclick="openAddProduct()">+ Add Product</button>
        </div>
        <div id="products-list"><div class="empty-state"><span class="spin"></span> Loading‚Ä¶</div></div>
      </div>
      <p style="font-size:.78rem;color:rgba(255,255,255,.2);text-align:center;padding:1rem;">Products you add here will show on your store page with your prices. Customers pay your price; your profit is credited to your wallet.</p>
    </div>

    <!-- ORDERS TAB -->
    <div id="tab-orders" class="hidden">
      <div class="panel">
        <div class="panel-head"><h3>All My Orders</h3></div>
        <div id="orders-list"><div class="empty-state">No orders yet.</div></div>
      </div>
    </div>

    <!-- WALLET TAB -->
    <div id="tab-wallet" class="hidden">
      <div class="wallet-card" style="margin-bottom:1.5rem;">
        <div class="wallet-lbl">Current Balance</div>
        <div class="wallet-row">
          <div>
            <div class="wallet-bal" id="wallet-bal-2">GHS 0.00</div>
            <div class="wallet-sub">Profits from your store sales</div>
          </div>
          <div>
            <button class="cashout-btn" id="cashout-btn-2" onclick="openCashoutModal()">Request Cashout</button>
            <div class="cashout-hint" id="cashout-hint-2"></div>
          </div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-head"><h3>Cashout History</h3></div>
        <div id="cashout-list"><div class="empty-state">No cashout requests yet.</div></div>
      </div>
    </div>

    <!-- STORE LINK TAB -->
    <div id="tab-store" class="hidden">
      <div class="panel" style="padding:2rem;">
        <div class="panel-head" style="border:none;padding:0;margin-bottom:1.5rem;"><h3>üîó Your Store Link</h3></div>
        <p style="font-size:.88rem;color:rgba(255,255,255,.4);line-height:1.65;margin-bottom:1.25rem;">Share this link with your customers. When they buy through your link, you earn your markup profit ‚Äî automatically added to your wallet.</p>
        <div class="link-copy-box">
          <div class="link-url" id="store-link-url">Loading‚Ä¶</div>
          <button class="copy-btn" onclick="copyStoreLink()">üìã Copy Link</button>
        </div>
        <div style="margin-top:1.5rem;padding:1.25rem;background:rgba(0,229,176,.04);border:1px solid rgba(0,229,176,.1);border-radius:14px;">
          <div style="font-weight:800;color:var(--mint);margin-bottom:.6rem;font-size:.9rem;">üí° How it works</div>
          <ul style="font-size:.83rem;color:rgba(255,255,255,.4);line-height:1.8;padding-left:1.25rem;">
            <li>Customer visits your link and buys a bundle</li>
            <li>They pay your price (agent cost + your markup)</li>
            <li>A 2.5% platform fee is added to the total</li>
            <li>Your profit is instantly credited to your wallet</li>
            <li>Admin processes the order delivery as normal</li>
          </ul>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ADD/EDIT PRODUCT MODAL -->
<div class="modal-bg" id="prod-modal">
  <div class="modal-box">
    <div class="modal-title" id="prod-modal-title">Add Product to Store</div>
    <form onsubmit="saveAgentProduct(event)">
      <input type="hidden" id="prod-doc-id"/>
      <div class="m-lbl">Base Product</div>
      <select class="m-inp" id="prod-base-select" onchange="onBaseProductChange()">
        <option value="">‚Äî Select a product ‚Äî</option>
      </select>
      <div class="m-hint">Products available at your agent price</div>

      <div id="agent-price-display" style="display:none;margin-top:.75rem;">
        <div class="m-lbl">Your Agent Cost (Base Price)</div>
        <div style="font-weight:800;color:rgba(255,255,255,.6);font-size:1.1rem;padding:.6rem 0;" id="agent-cost-display">‚Äî</div>
      </div>

      <div id="markup-section" style="display:none;">
        <div class="m-lbl">Your Markup (profit per sale, GHS)</div>
        <input class="m-inp" type="number" id="prod-markup" step="0.01" min="0" placeholder="e.g. 2.00" oninput="updatePriceCalc()"/>

        <div class="price-calc" id="price-calc">
          <div class="calc-row"><span>Agent cost:</span><strong id="calc-agent-cost">‚Äî</strong></div>
          <div class="calc-row profit"><span>Your markup:</span><strong id="calc-markup">GHS 0.00</strong></div>
          <div class="calc-row"><span>Platform fee (2.5%):</span><strong id="calc-fee">‚Äî</strong></div>
          <div class="calc-total"><span>Customer pays:</span><span id="calc-total" style="color:var(--mint);">‚Äî</span></div>
        </div>
      </div>

      <div class="m-btns">
        <button type="button" class="m-cancel" onclick="closeProdModal()">Cancel</button>
        <button type="submit" class="m-save" id="save-prod-btn">Add to Store</button>
      </div>
    </form>
  </div>
</div>

<!-- CASHOUT MODAL -->
<div class="modal-bg" id="cashout-modal">
  <div class="modal-box">
    <div class="modal-title">Request Cashout üí∞</div>
    <form onsubmit="submitCashout(event)">
      <p style="font-size:.85rem;color:rgba(255,255,255,.4);margin-bottom:1.25rem;line-height:1.6;">Your cashout will be processed manually within 24 hours. Ensure your account details are correct.</p>
      <div class="m-lbl">Amount to Cashout (GHS)</div>
      <input class="m-inp" type="number" id="cashout-amount" step="0.01" min="5" placeholder="Min: GHS 5.00"/>
      <div class="m-hint">Available: <span id="cashout-available">GHS 0.00</span></div>
      <div class="m-lbl" style="margin-top:1rem;">Mobile Money Number</div>
      <input class="m-inp" type="tel" id="cashout-momo" placeholder="05XXXXXXXX" maxlength="10"/>
      <div class="m-lbl" style="margin-top:.75rem;">Network (MTN / Telecel / AT)</div>
      <select class="m-inp" id="cashout-network"><option>MTN MoMo</option><option>Telecel Cash</option><option>AT Money</option></select>
      <div class="m-lbl" style="margin-top:.75rem;">Account Name</div>
      <input class="m-inp" type="text" id="cashout-name" placeholder="Name on MoMo account"/>
      <div class="m-btns">
        <button type="button" class="m-cancel" onclick="closeCashoutModal()">Cancel</button>
        <button type="submit" class="m-save" id="cashout-submit-btn">Submit Request</button>
      </div>
    </form>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, onSnapshot, addDoc, updateDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

// ‚úÖ FIXED: Using correct Firebase config (dataplus-a93c7)
const firebaseConfig = {
  apiKey: "AIzaSyCs7lN4itvWZPichtFLdEE4swNQHSX_j1M",
  authDomain: "dataplus-a93c7.firebaseapp.com",
  projectId: "dataplus-a93c7",
  storageBucket: "dataplus-a93c7.firebasestorage.app",
  messagingSenderId: "1040979049946",
  appId: "1:1040979049946:web:d5d7957a6c209f56dd94e3",
  measurementId: "G-GW9DNT0DQ0"
};

const GLOBAL_ORDERS = 'swiftdata_global_orders';
const APP_ID = 'swiftdata-main-app';
const FEE_RATE = 0.025;

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let agentData = null, agentUid = null;
let baseProducts = [], agentProducts = [], myOrders = [], cashoutRequests = [];

// ‚úÖ FIXED: Better auth guard with error handling
onAuthStateChanged(auth, async user => {
  if (!user) {
    window.location.href = '/agent.login';
    return;
  }
  
  agentUid = user.uid;
  
  try {
    const agentDoc = await getDoc(doc(db, 'swiftdata_agents', agentUid));
    
    if (!agentDoc.exists()) {
      console.error('Agent document not found');
      await signOut(auth);
      window.location.href = '/agent.login';
      return;
    }
    
    const status = agentDoc.data().status;
    if (status !== 'active') {
      console.warn('Agent status:', status);
      await signOut(auth);
      window.location.href = '/agent.login';
      return;
    }
    
    agentData = agentDoc.data();
    initDashboard();
  } catch (error) {
    console.error('Auth check failed:', error);
    alert('Connection error. Please refresh the page.');
  }
});

function initDashboard() {
  const initials = (agentData.name || 'A').split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
  document.getElementById('sb-initials').textContent = initials;
  document.getElementById('sb-agent-name').textContent = `@${agentData.username}`;
  document.getElementById('sb-uname-txt').textContent = agentData.name || 'Agent';
  document.getElementById('sb-email-txt').textContent = agentData.email || '';
  
  const domain = window.location.origin;
  const storeUrl = `${domain}/store?agent=${agentData.username}`;
  document.getElementById('store-link-url').textContent = storeUrl;

  // ‚úÖ FIXED: Added error handlers to all listeners
  
  // Live agent data listener
  onSnapshot(
    doc(db, 'swiftdata_agents', agentUid),
    (d) => {
      if (!d.exists()) return;
      agentData = {...agentData, ...d.data()};
      updateWalletUI();
    },
    (error) => {
      console.error('Agent listener error:', error);
      if (error.code === 'permission-denied') {
        console.error('Firestore rules may not be configured correctly');
      }
    }
  );

  // Base products listener
  onSnapshot(
    collection(db, 'artifacts', APP_ID, 'public', 'data', 'products'),
    (snap) => {
      baseProducts = snap.docs.map(d => ({id: d.id, ...d.data()}))
        .sort((a, b) => (a.rank || 999) - (b.rank || 999));
      populateProductDropdown();
    },
    (error) => {
      console.error('Products listener error:', error);
    }
  );

  // Agent products listener
  onSnapshot(
    collection(db, 'swiftdata_agents', agentUid, 'products'),
    (snap) => {
      agentProducts = snap.docs.map(d => ({id: d.id, ...d.data()}));
      renderAgentProducts();
      const visibleCount = agentProducts.filter(p => p.visible).length;
      document.getElementById('stat-prods').textContent = visibleCount;
    },
    (error) => {
      console.error('Agent products listener error:', error);
      if (error.code === 'permission-denied') {
        document.getElementById('products-list').innerHTML = 
          '<div class="error-msg">Cannot load products due to permissions. Make sure Firestore rules are configured.</div>';
      }
    }
  );

  // My orders listener
  onSnapshot(
    query(collection(db, GLOBAL_ORDERS), where('agentId', '==', agentUid)),
    (snap) => {
      myOrders = snap.docs
        .map(d => ({id: d.id, ...d.data()}))
        .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
      renderOrders();
      document.getElementById('stat-orders').textContent = myOrders.length;
    },
    (error) => {
      console.error('Orders listener error:', error);
    }
  );

  // Cashout requests listener
  onSnapshot(
    query(collection(db, 'swiftdata_cashout_requests'), where('agentId', '==', agentUid)),
    (snap) => {
      cashoutRequests = snap.docs
        .map(d => ({id: d.id, ...d.data()}))
        .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
      renderCashouts();
    },
    (error) => {
      console.error('Cashout listener error:', error);
    }
  );
}

function updateWalletUI() {
  const bal = agentData.walletBalance || 0;
  const earned = agentData.totalEarned || 0;
  const balStr = `GHS ${bal.toFixed(2)}`;
  const earnedStr = `GHS ${earned.toFixed(2)}`;
  
  document.getElementById('stat-wallet').textContent = balStr;
  document.getElementById('stat-earned').textContent = earnedStr;
  document.getElementById('wallet-bal').textContent = balStr;
  document.getElementById('wallet-bal-2').textContent = balStr;
  document.getElementById('cashout-available').textContent = balStr;
  
  const canCashout = bal >= 5;
  ['cashout-btn', 'cashout-btn-2'].forEach(id => {
    const b = document.getElementById(id);
    if (b) b.disabled = !canCashout;
  });
  
  ['cashout-hint', 'cashout-hint-2'].forEach(id => {
    const h = document.getElementById(id);
    if (h) h.textContent = canCashout ? '' : 'Need GHS 5+ to cashout';
  });
}

// TABS
window.showTab = (tab) => {
  ['overview', 'products', 'orders', 'wallet', 'store'].forEach(t => {
    document.getElementById(`tab-${t}`).classList.toggle('hidden', t !== tab);
  });
  
  document.querySelectorAll('.sb-btn').forEach(b => b.classList.remove('active'));
  const btnMap = {overview: 0, products: 1, orders: 2, wallet: 3, store: 4};
  const btns = document.querySelectorAll('.sb-btn');
  if (btns[btnMap[tab]]) btns[btnMap[tab]].classList.add('active');
  
  const titles = {overview: 'Overview', products: 'My Products', orders: 'My Orders', wallet: 'Wallet & Cashout', store: 'My Store Link'};
  document.getElementById('top-title').textContent = titles[tab] || tab;
};

// STORE LINK COPY
window.copyStoreLink = () => {
  const url = document.getElementById('store-link-url').textContent;
  navigator.clipboard.writeText(url).then(() => {
    const chip = document.getElementById('store-chip');
    chip.textContent = '‚úì Copied!';
    setTimeout(() => chip.textContent = 'üìé Copy Store Link', 2000);
  }).catch(() => alert(`Your store link: ${url}`));
};

// RENDER AGENT PRODUCTS
function renderAgentProducts() {
  const el = document.getElementById('products-list');
  if (!agentProducts.length) {
    el.innerHTML = '<div class="empty-state">No products yet. Click "+ Add Product" to get started.</div>';
    return;
  }
  
  el.innerHTML = agentProducts.map(p => {
    const profit = (p.markup || 0).toFixed(2);
    return `<div class="prod-row">
      <div class="prod-info">
        <span class="pnet">${p.network}</span>
        <div class="psize">${p.size}</div>
        <div class="ptype">${p.type || 'Standard'}</div>
      </div>
      <div class="prod-prices">
        <div class="price-row"><span class="price-label">Agent cost:</span><span class="agent-cost">GHS ${parseFloat(p.agentCost || 0).toFixed(2)}</span></div>
        <div class="price-row"><span class="price-label">Customer pays:</span><span class="store-price">GHS ${parseFloat(p.storePrice || 0).toFixed(2)}</span></div>
        <span class="profit-badge">+GHS ${profit} profit</span>
      </div>
      <div style="display:flex;gap:.5rem;align-items:center;">
        <button class="toggle-btn ${p.visible ? 'visible' : 'hidden'}" onclick="toggleProductVisibility('${p.id}',${!p.visible})">${p.visible ? 'üëÅ Visible' : 'Hidden'}</button>
        <button class="edit-prod-btn" onclick="openEditProduct('${p.id}')">Edit</button>
      </div>
    </div>`;
  }).join('');
}

// RENDER ORDERS
function renderOrders() {
  const el = document.getElementById('orders-list');
  const recEl = document.getElementById('recent-orders-list');
  
  if (!myOrders.length) {
    const empty = '<div class="empty-state">No orders yet ‚Äî share your store link to start earning!</div>';
    el.innerHTML = empty;
    recEl.innerHTML = empty;
    return;
  }
  
  const html = myOrders.map(o => `
    <div class="order-row">
      <div class="o-top">
        <span class="o-bundle">${o.size} (${o.network})</span>
        <span class="o-status s-${o.status}">${o.status}</span>
      </div>
      <div class="o-phone">üì± ${o.recipient}</div>
      <div class="o-meta">${o.orderRef || ''} ¬∑ ${o.createdAt ? new Date(o.createdAt.seconds * 1000).toLocaleString() : 'Just now'}</div>
      ${o.agentProfit > 0 ? `<div class="o-profit">+GHS ${parseFloat(o.agentProfit).toFixed(2)} profit</div>` : ''}
    </div>`).join('');
  
  el.innerHTML = html;
  recEl.innerHTML = myOrders.slice(0, 5).map(o => `
    <div class="order-row">
      <div class="o-top"><span class="o-bundle">${o.size} (${o.network})</span><span class="o-status s-${o.status}">${o.status}</span></div>
      <div class="o-phone">üì± ${o.recipient}</div>
      ${o.agentProfit > 0 ? `<div class="o-profit">+GHS ${parseFloat(o.agentProfit).toFixed(2)}</div>` : ''}
    </div>`).join('');
}

// RENDER CASHOUTS
function renderCashouts() {
  const el = document.getElementById('cashout-list');
  if (!cashoutRequests.length) {
    el.innerHTML = '<div class="empty-state">No cashout requests yet.</div>';
    return;
  }
  
  el.innerHTML = cashoutRequests.map(c => `
    <div class="cashout-row">
      <div>
        <div class="cashout-amt">GHS ${parseFloat(c.amount).toFixed(2)}</div>
        <div style="font-size:.75rem;color:rgba(255,255,255,.3);">${c.momoNumber} (${c.momoNetwork}) ¬∑ ${c.createdAt ? new Date(c.createdAt.seconds * 1000).toLocaleDateString() : '‚Äî'}</div>
      </div>
      <span class="cashout-status cs-${c.status || 'pending'}">${c.status || 'Pending'}</span>
    </div>`).join('');
}

// PRODUCT MODAL
function populateProductDropdown() {
  const sel = document.getElementById('prod-base-select');
  sel.innerHTML = '<option value="">‚Äî Select a product ‚Äî</option>' +
    baseProducts.map(p => `<option value="${p.id}" data-agent-price="${p.agent_price || p.price}" data-size="${p.size}" data-network="${p.network}" data-type="${p.type || 'Standard'}">${p.network} ¬∑ ${p.size} (Agent: GHS ${parseFloat(p.agent_price || p.price).toFixed(2)})</option>`).join('');
}

window.openAddProduct = () => {
  document.getElementById('prod-doc-id').value = '';
  document.getElementById('prod-modal-title').textContent = 'Add Product to Store';
  document.getElementById('prod-base-select').value = '';
  document.getElementById('prod-markup').value = '';
  document.getElementById('agent-price-display').style.display = 'none';
  document.getElementById('markup-section').style.display = 'none';
  document.getElementById('prod-modal').classList.add('show');
};

window.openEditProduct = (id) => {
  const p = agentProducts.find(x => x.id === id);
  if (!p) return;
  
  document.getElementById('prod-doc-id').value = id;
  document.getElementById('prod-modal-title').textContent = 'Edit Product';
  const sel = document.getElementById('prod-base-select');
  sel.value = p.baseProductId || '';
  document.getElementById('prod-markup').value = p.markup || 0;
  document.getElementById('agent-cost-display').textContent = `GHS ${parseFloat(p.agentCost || 0).toFixed(2)}`;
  document.getElementById('agent-price-display').style.display = 'block';
  document.getElementById('markup-section').style.display = 'block';
  updatePriceCalc();
  document.getElementById('prod-modal').classList.add('show');
};

window.onBaseProductChange = () => {
  const sel = document.getElementById('prod-base-select');
  const opt = sel.options[sel.selectedIndex];
  if (!opt.value) {
    document.getElementById('agent-price-display').style.display = 'none';
    document.getElementById('markup-section').style.display = 'none';
    return;
  }
  
  const agentPrice = parseFloat(opt.dataset.agentPrice) || 0;
  document.getElementById('agent-cost-display').textContent = `GHS ${agentPrice.toFixed(2)}`;
  document.getElementById('agent-price-display').style.display = 'block';
  document.getElementById('markup-section').style.display = 'block';
  document.getElementById('prod-markup').value = '';
  updatePriceCalc();
};

window.updatePriceCalc = () => {
  const sel = document.getElementById('prod-base-select');
  const opt = sel.options[sel.selectedIndex];
  if (!opt || !opt.value) return;
  
  const agentCost = parseFloat(opt.dataset.agentPrice) || 0;
  const markup = parseFloat(document.getElementById('prod-markup').value) || 0;
  const storeBase = agentCost + markup;
  const fee = storeBase * FEE_RATE;
  const total = storeBase + fee;
  
  document.getElementById('calc-agent-cost').textContent = `GHS ${agentCost.toFixed(2)}`;
  document.getElementById('calc-markup').textContent = `GHS ${markup.toFixed(2)}`;
  document.getElementById('calc-fee').textContent = `GHS ${fee.toFixed(2)}`;
  document.getElementById('calc-total').textContent = `GHS ${total.toFixed(2)}`;
};

window.closeProdModal = () => document.getElementById('prod-modal').classList.remove('show');

window.saveAgentProduct = async (e) => {
  e.preventDefault();
  
  const docId = document.getElementById('prod-doc-id').value;
  const sel = document.getElementById('prod-base-select');
  const opt = sel.options[sel.selectedIndex];
  
  if (!opt || !opt.value) {
    alert('Please select a product.');
    return;
  }
  
  const markup = parseFloat(document.getElementById('prod-markup').value) || 0;
  const agentCost = parseFloat(opt.dataset.agentPrice) || 0;
  const storePrice = agentCost + markup;
  
  const prodData = {
    baseProductId: opt.value,
    network: opt.dataset.network,
    size: opt.dataset.size,
    type: opt.dataset.type,
    agentCost,
    markup,
    storePrice,
    visible: true,
    agentId: agentUid,
    updatedAt: serverTimestamp()
  };
  
  const btn = document.getElementById('save-prod-btn');
  btn.disabled = true;
  btn.textContent = 'Saving‚Ä¶';
  
  try {
    if (docId) {
      await updateDoc(doc(db, 'swiftdata_agents', agentUid, 'products', docId), prodData);
    } else {
      await addDoc(collection(db, 'swiftdata_agents', agentUid, 'products'), {
        ...prodData,
        createdAt: serverTimestamp()
      });
    }
    closeProdModal();
  } catch (err) {
    console.error('Save product error:', err);
    alert('Error saving product: ' + err.message);
  }
  
  btn.disabled = false;
  btn.textContent = 'Add to Store';
};

window.toggleProductVisibility = async (id, visible) => {
  try {
    await updateDoc(doc(db, 'swiftdata_agents', agentUid, 'products', id), {visible});
  } catch (err) {
    console.error('Toggle visibility error:', err);
    alert('Error updating product visibility');
  }
};

// CASHOUT
window.openCashoutModal = () => {
  const bal = agentData.walletBalance || 0;
  if (bal < 5) {
    alert('You need at least GHS 5.00 to request a cashout.');
    return;
  }
  document.getElementById('cashout-amount').value = bal.toFixed(2);
  document.getElementById('cashout-modal').classList.add('show');
};

window.closeCashoutModal = () => document.getElementById('cashout-modal').classList.remove('show');

window.submitCashout = async (e) => {
  e.preventDefault();
  
  const amount = parseFloat(document.getElementById('cashout-amount').value);
  const momo = document.getElementById('cashout-momo').value.replace(/\D/g, '');
  const network = document.getElementById('cashout-network').value;
  const name = document.getElementById('cashout-name').value.trim();
  const bal = agentData.walletBalance || 0;
  
  if (amount < 5) {
    alert('Minimum cashout is GHS 5.00');
    return;
  }
  if (amount > bal) {
    alert('Amount exceeds your wallet balance.');
    return;
  }
  if (momo.length !== 10) {
    alert('Enter a valid 10-digit MoMo number.');
    return;
  }
  if (!name) {
    alert('Enter the account name.');
    return;
  }
  
  const btn = document.getElementById('cashout-submit-btn');
  btn.disabled = true;
  btn.textContent = 'Submitting‚Ä¶';
  
  try {
    await addDoc(collection(db, 'swiftdata_cashout_requests'), {
      agentId: agentUid,
      agentName: agentData.name,
      agentUsername: agentData.username,
      amount,
      momoNumber: momo,
      momoNetwork: network,
      accountName: name,
      status: 'pending',
      createdAt: serverTimestamp()
    });
    
    // Deduct from wallet
    await updateDoc(doc(db, 'swiftdata_agents', agentUid), {
      walletBalance: (bal - amount)
    });
    
    closeCashoutModal();
    alert(`Cashout request for GHS ${amount.toFixed(2)} submitted! We'll process it within 24 hours.`);
  } catch (err) {
    console.error('Cashout error:', err);
    alert('Error submitting cashout request: ' + err.message);
  }
  
  btn.disabled = false;
  btn.textContent = 'Submit Request';
};

// LOGOUT
window.doLogout = async () => {
  try {
    await signOut(auth);
    window.location.href = '/';
  } catch (err) {
    console.error('Logout error:', err);
  }
};
</script>
</body>
</html>
