<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SwiftData Agent — Login / Register</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<style>
:root{--ink:#0a0f1e;--blue:#0051ff;--mint:#00e5b0;--yellow:#f59e0b;--green:#22c55e;--red:#ef4444;}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Plus Jakarta Sans',sans-serif;background:#060b18;color:#fff;min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden;}
.container{flex:1;display:flex;align-items:center;justify-content:center;padding:2rem 1.5rem;}
.main-box{background:rgba(255,255,255,.02);border:1px solid rgba(0,81,255,.15);border-radius:28px;padding:3rem;max-width:460px;width:100%;backdrop-filter:blur(10px);}
.logo-sec{text-align:center;margin-bottom:2.5rem;}
.logo{font-weight:800;font-size:1.4rem;color:#fff;}.logo span{color:var(--mint);}
.logo-sub{font-size:.75rem;color:rgba(255,255,255,.25);text-transform:uppercase;letter-spacing:2px;margin-top:.5rem;}
.page-title{font-weight:800;font-size:1.4rem;text-align:center;margin-bottom:.35rem;}
.page-sub{font-size:.82rem;color:rgba(255,255,255,.35);text-align:center;margin-bottom:2rem;}
.toggle-sec{display:flex;gap:.5rem;margin-bottom:2rem;}
.toggle-btn{flex:1;padding:.7rem;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);color:rgba(255,255,255,.4);border-radius:12px;font-family:inherit;font-weight:700;cursor:pointer;transition:all .2s;font-size:.85rem;}
.toggle-btn.active{background:var(--blue);border-color:var(--blue);color:#fff;box-shadow:0 6px 18px rgba(0,81,255,.3);}
.form-sec{display:none;}
.form-sec.show{display:block;}
.form-group{margin-bottom:1.25rem;}
.form-label{font-size:.68rem;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:rgba(255,255,255,.3);margin-bottom:.5rem;display:block;}
.form-input{width:100%;padding:.85rem 1rem;background:rgba(255,255,255,.04);border:1.5px solid rgba(255,255,255,.08);border-radius:12px;font-family:inherit;font-size:.95rem;color:#fff;outline:none;transition:border-color .2s;}
.form-input::placeholder{color:rgba(255,255,255,.18);}
.form-input:focus{border-color:rgba(0,81,255,.5);box-shadow:0 0 0 4px rgba(0,81,255,.1);}
.error-msg{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);color:#fca5a5;padding:.6rem;border-radius:10px;font-size:.78rem;margin-top:.3rem;display:none;}
.error-msg.show{display:block;}
.form-btn{width:100%;padding:.9rem;background:var(--blue);color:#fff;border:none;border-radius:12px;font-family:inherit;font-weight:800;font-size:.95rem;cursor:pointer;transition:all .2s;margin-top:.5rem;}
.form-btn:hover:not(:disabled){box-shadow:0 10px 28px rgba(0,81,255,.35);transform:translateY(-2px);}
.form-btn:disabled{opacity:.4;cursor:not-allowed;}
.login-link{text-align:center;font-size:.85rem;color:rgba(255,255,255,.4);margin-top:1.5rem;}
.login-link a{color:var(--mint);text-decoration:none;font-weight:700;}
.spin{width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:sp .6s linear infinite;display:inline-block;vertical-align:middle;margin-right:.5rem;}
@keyframes sp{to{transform:rotate(360deg);}}
</style>
</head>
<body>
<div class="container">
  <div class="main-box">
    <div class="logo-sec">
      <div class="logo">SwiftData<span>GH</span></div>
      <div class="logo-sub">Agent Portal</div>
    </div>

    <!-- LOGIN -->
    <div class="form-sec show" id="login-form">
      <h2 class="page-title">Sign In</h2>
      <p class="page-sub">Access your dashboard</p>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input class="form-input" id="login-email" type="email" placeholder="your@email.com"/>
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input class="form-input" id="login-password" type="password" placeholder="••••••••"/>
      </div>
      <div id="login-error" class="error-msg"></div>
      <button class="form-btn" id="login-btn" onclick="handleLogin()">Sign In</button>
      <div class="login-link">
        New? <a href="#" onclick="switchForm('signup'); return false;">Create account →</a>
      </div>
    </div>

    <!-- SIGNUP -->
    <div class="form-sec" id="signup-form">
      <h2 class="page-title">Create Account</h2>
      <p class="page-sub">Join and start earning</p>
      <div class="form-group">
        <label class="form-label">Full Name</label>
        <input class="form-input" id="signup-name" type="text" placeholder="Your name"/>
      </div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input class="form-input" id="signup-email" type="email" placeholder="your@email.com"/>
      </div>
      <div class="form-group">
        <label class="form-label">Username</label>
        <input class="form-input" id="signup-username" type="text" placeholder="username" oninput="checkUsername()"/>
        <div id="username-hint" style="font-size:.7rem;color:rgba(255,255,255,.2);margin-top:.3rem;"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input class="form-input" id="signup-password" type="password" placeholder="••••••••"/>
        <div style="font-size:.72rem;color:rgba(255,255,255,.2);margin-top:.3rem;">Min 6 chars</div>
      </div>
      <div class="form-group">
        <label class="form-label">Confirm Password</label>
        <input class="form-input" id="signup-confirm" type="password" placeholder="••••••••"/>
      </div>
      <div id="signup-error" class="error-msg"></div>
      <button class="form-btn" id="signup-btn" onclick="handleSignup()">Create Account</button>
      <div class="login-link">
        Have account? <a href="#" onclick="switchForm('login'); return false;">Sign in →</a>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, query, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCs7lN4itvWZPichtFLdEE4swNQHSX_j1M",
  authDomain: "dataplus-a93c7.firebaseapp.com",
  projectId: "dataplus-a93c7",
  storageBucket: "dataplus-a93c7.firebasestorage.app",
  messagingSenderId: "1040979049946",
  appId: "1:1040979049946:web:d5d7957a6c209f56dd94e3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let usernameCheckTimeout;

// Check if already logged in
onAuthStateChanged(auth, (user) => {
  if (user) {
    window.location.href = '/agent.dashboard';
  }
});

window.switchForm = (form) => {
  document.getElementById('login-form').classList.toggle('show', form === 'login');
  document.getElementById('signup-form').classList.toggle('show', form === 'signup');
  document.getElementById('login-error').classList.remove('show');
  document.getElementById('signup-error').classList.remove('show');
};

window.checkUsername = async () => {
  clearTimeout(usernameCheckTimeout);
  const username = document.getElementById('signup-username').value.trim().toLowerCase();
  const hint = document.getElementById('username-hint');

  if (!username) {
    hint.textContent = '';
    return;
  }

  if (username.length < 3) {
    hint.textContent = '⚠ At least 3 characters';
    hint.style.color = 'rgba(255,255,255,.3)';
    return;
  }

  hint.textContent = '⏳ Checking...';
  hint.style.color = 'rgba(255,255,255,.2)';

  usernameCheckTimeout = setTimeout(async () => {
    try {
      const q = query(collection(db, 'swiftdata_agents'), where('username', '==', username), limit(1));
      const snap = await getDocs(q);

      if (snap.empty) {
        hint.textContent = '✓ Available';
        hint.style.color = 'var(--green)';
      } else {
        hint.textContent = '✗ Taken';
        hint.style.color = 'var(--red)';
      }
    } catch (error) {
      console.error('Username check error:', error);
      hint.textContent = '⚠ Error checking';
      hint.style.color = 'var(--yellow)';
    }
  }, 800);
};

window.handleLogin = async () => {
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  const btn = document.getElementById('login-btn');
  const err = document.getElementById('login-error');

  if (!email || !password) {
    err.textContent = 'Please enter email and password.';
    err.classList.add('show');
    return;
  }

  btn.disabled = true;
  btn.innerHTML = '<span class="spin"></span>Signing in...';
  err.classList.remove('show');

  try {
    await signInWithEmailAndPassword(auth, email, password);
    setTimeout(() => window.location.href = '/agent.dashboard', 500);
  } catch (error) {
    console.error('Login error:', error);
    btn.disabled = false;
    btn.innerHTML = 'Sign In';

    if (error.code === 'auth/invalid-credential') {
      err.textContent = 'Invalid email or password.';
    } else if (error.code === 'auth/user-not-found') {
      err.textContent = 'No account found.';
    } else {
      err.textContent = error.message || 'Login failed.';
    }
    err.classList.add('show');
  }
};

window.handleSignup = async () => {
  const name = document.getElementById('signup-name').value.trim();
  const email = document.getElementById('signup-email').value.trim();
  const username = document.getElementById('signup-username').value.trim().toLowerCase();
  const password = document.getElementById('signup-password').value;
  const confirm = document.getElementById('signup-confirm').value;

  const btn = document.getElementById('signup-btn');
  const err = document.getElementById('signup-error');

  err.classList.remove('show');

  if (!name || !email || !username || !password) {
    err.textContent = 'Please fill all fields.';
    err.classList.add('show');
    return;
  }

  if (username.length < 3) {
    err.textContent = 'Username must be 3+ characters.';
    err.classList.add('show');
    return;
  }

  if (password.length < 6) {
    err.textContent = 'Password must be 6+ characters.';
    err.classList.add('show');
    return;
  }

  if (password !== confirm) {
    err.textContent = 'Passwords don\'t match.';
    err.classList.add('show');
    return;
  }

  btn.disabled = true;
  btn.innerHTML = '<span class="spin"></span>Creating...';

  try {
    // Check username availability
    const q = query(collection(db, 'swiftdata_agents'), where('username', '==', username), limit(1));
    const snap = await getDocs(q);
    if (!snap.empty) {
      throw new Error('Username already taken.');
    }

    // Create auth user
    const authResult = await createUserWithEmailAndPassword(auth, email, password);
    const uid = authResult.user.uid;

    // Create agent doc
    await setDoc(doc(db, 'swiftdata_agents', uid), {
      uid: uid,
      name: name,
      email: email,
      username: username,
      status: 'pending',
      walletBalance: 0,
      totalEarned: 0,
      totalOrders: 0,
      createdAt: new Date()
    });

    console.log('Agent created:', uid);
    err.textContent = '✓ Account created! Redirecting...';
    err.style.color = 'var(--green)';
    err.classList.add('show');

    setTimeout(() => window.location.href = '/agent.dashboard', 1500);

  } catch (error) {
    console.error('Signup error:', error);
    btn.disabled = false;
    btn.innerHTML = 'Create Account';

    if (error.message.includes('already taken')) {
      err.textContent = 'Username already taken.';
    } else if (error.code === 'auth/email-already-in-use') {
      err.textContent = 'Email already registered.';
    } else {
      err.textContent = error.message || 'Signup failed.';
    }
    err.classList.add('show');
  }
};
</script>
</body>
</html>
