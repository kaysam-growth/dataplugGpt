<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Agent Portal ‚Äî SwiftData GH</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<script src="https://js.paystack.co/v2/inline.js"></script>
<style>
:root{--blue:#0051ff;--sky:#38bdf8;--mint:#00e5b0;--yellow:#f59e0b;--green:#22c55e;--red:#ef4444;}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Plus Jakarta Sans',sans-serif;background:#060b18;color:#fff;min-height:100vh;display:flex;flex-direction:column;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 70% 60% at 30% 40%,rgba(0,81,255,.07) 0%,transparent 60%),radial-gradient(ellipse 50% 40% at 75% 70%,rgba(0,229,176,.05) 0%,transparent 60%);pointer-events:none;}
nav{height:64px;display:flex;align-items:center;border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0;}
.nav-inner{max-width:1100px;margin:0 auto;width:100%;padding:0 5%;display:flex;align-items:center;justify-content:space-between;}
.logo{font-weight:800;font-size:1.25rem;color:#fff;text-decoration:none;letter-spacing:-.3px;}
.logo span{color:var(--mint);}
.nav-home{color:rgba(255,255,255,.45);text-decoration:none;font-size:.85rem;font-weight:600;transition:color .2s;}
.nav-home:hover{color:#fff;}
.page-wrap{flex:1;display:flex;align-items:center;justify-content:center;padding:2rem 1.5rem;}
.auth-card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:28px;padding:2.5rem;max-width:480px;width:100%;backdrop-filter:blur(20px);animation:fadeUp .35s ease;}
.auth-tabs{display:flex;background:rgba(255,255,255,.05);border-radius:12px;padding:3px;margin-bottom:2rem;}
.auth-tab{flex:1;padding:.55rem;border-radius:10px;border:none;background:none;color:rgba(255,255,255,.4);font-family:inherit;font-weight:700;font-size:.9rem;cursor:pointer;transition:all .2s;}
.auth-tab.active{background:var(--blue);color:#fff;box-shadow:0 4px 12px rgba(0,81,255,.35);}
.auth-form{display:none;}
.auth-form.show{display:block;}
.form-title{font-weight:800;font-size:1.3rem;margin-bottom:.35rem;}
.form-sub{font-size:.85rem;color:rgba(255,255,255,.35);margin-bottom:1.75rem;line-height:1.5;}
.flabel{font-size:.7rem;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:rgba(255,255,255,.3);margin-bottom:.4rem;}
.finput{width:100%;padding:.82rem 1rem;background:rgba(255,255,255,.05);border:1.5px solid rgba(255,255,255,.08);border-radius:12px;color:#fff;font-family:inherit;font-size:.92rem;outline:none;transition:border-color .2s;margin-bottom:.85rem;}
.finput::placeholder{color:rgba(255,255,255,.2);}
.finput:focus{border-color:rgba(0,81,255,.5);background:rgba(0,81,255,.05);}
.pw-wrap{position:relative;}
.pw-wrap .finput{padding-right:3rem;margin-bottom:0;}
.pw-eye{position:absolute;right:.85rem;top:50%;transform:translateY(-50%);background:none;border:none;color:rgba(255,255,255,.3);cursor:pointer;font-size:.9rem;}
.pw-eye:hover{color:#fff;}
.pw-margin{margin-bottom:.85rem;}
.field-hint{font-size:.75rem;color:rgba(255,255,255,.25);margin-bottom:.85rem;margin-top:-.5rem;word-break:break-all;}
.fee-box{background:rgba(0,229,176,.06);border:1.5px solid rgba(0,229,176,.18);border-radius:16px;padding:1.25rem;margin-bottom:1.5rem;}
.fee-box-title{display:flex;align-items:center;gap:.5rem;font-weight:800;font-size:.95rem;color:var(--mint);margin-bottom:.65rem;}
.fee-row{display:flex;justify-content:space-between;font-size:.85rem;color:rgba(255,255,255,.5);margin-bottom:.3rem;}
.fee-row strong{color:#fff;}
.fee-total{display:flex;justify-content:space-between;font-weight:800;font-size:1rem;margin-top:.6rem;padding-top:.6rem;border-top:1px solid rgba(0,229,176,.15);}
.fee-total .amount{color:var(--mint);font-size:1.2rem;}
.submit-btn{width:100%;padding:.9rem;background:var(--blue);color:#fff;border:none;border-radius:12px;font-family:inherit;font-weight:800;font-size:.95rem;cursor:pointer;transition:transform .2s,box-shadow .2s;display:flex;align-items:center;justify-content:center;gap:.5rem;}
.submit-btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 10px 28px rgba(0,81,255,.35);}
.submit-btn:disabled{opacity:.4;cursor:not-allowed;}
.submit-btn.mint-btn{background:linear-gradient(135deg,var(--mint),#00b4d8);color:#0a1020;}
.submit-btn.mint-btn:hover:not(:disabled){box-shadow:0 10px 28px rgba(0,229,176,.35);}
.err-box{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);color:#fca5a5;border-radius:10px;padding:.7rem 1rem;font-size:.83rem;margin-bottom:1rem;display:none;line-height:1.55;}
.err-box.show{display:block;}
.or-divider{text-align:center;font-size:.78rem;color:rgba(255,255,255,.2);margin:1.25rem 0;}
.switch-link{text-align:center;font-size:.83rem;color:rgba(255,255,255,.35);}
.switch-link button{background:none;border:none;color:var(--mint);cursor:pointer;font-weight:700;font-family:inherit;font-size:.83rem;}
.switch-link button:hover{text-decoration:underline;}
.spin{width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:sp .7s linear infinite;display:inline-block;}
@keyframes sp{to{transform:rotate(360deg);}}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);}}
footer{text-align:center;padding:1.25rem;font-size:.75rem;color:rgba(255,255,255,.15);}
</style>
</head>
<body>
<nav>
  <div class="nav-inner">
    <a href="/" class="logo">SwiftData<span>GH</span></a>
    <a href="/" class="nav-home">‚Üê Back to Store</a>
  </div>
</nav>

<div class="page-wrap">
  <div class="auth-card">
    <div class="auth-tabs">
      <button class="auth-tab active" id="tab-signup" onclick="switchTab('signup')">Create Account</button>
      <button class="auth-tab" id="tab-login" onclick="switchTab('login')">Login</button>
    </div>

    <!-- SIGNUP -->
    <div class="auth-form show" id="form-signup">
      <div class="form-title">Become an Agent ‚ö°</div>
      <div class="form-sub">Sign up, pay the one-time activation fee, and get your own store dashboard immediately.</div>
      <div id="signup-err" class="err-box"></div>
      <form onsubmit="handleSignup(event)">
        <div class="flabel">Full Name / Store Name</div>
        <input class="finput" type="text" id="su-name" placeholder="e.g. Kwame's Data Store" required/>

        <div class="flabel">Username (your store link ID)</div>
        <input class="finput" type="text" id="su-username" placeholder="e.g. kwame123" required oninput="sanitizeUsername(this)"/>
        <div class="field-hint">Your store link: swiftdatagh.vercel.app/store?agent=<span id="hint-username">kwame123</span></div>

        <div class="flabel">Email Address</div>
        <input class="finput" type="email" id="su-email" placeholder="your@email.com" required/>

        <div class="flabel">Password</div>
        <div class="pw-wrap pw-margin">
          <input class="finput" type="password" id="su-pass" placeholder="At least 6 characters" required/>
          <button type="button" class="pw-eye" onclick="togglePw('su-pass')">üëÅ</button>
        </div>

        <div class="flabel">Phone Number <span style="color:rgba(255,255,255,.2);font-weight:400;text-transform:none;letter-spacing:0;">(optional)</span></div>
        <input class="finput" type="tel" id="su-phone" placeholder="05XXXXXXXX" maxlength="10" inputmode="numeric"/>

        <div class="fee-box">
          <div class="fee-box-title">‚ö° Store Activation Fee</div>
          <div class="fee-row"><span>One-time activation</span><strong>GHS 24.39</strong></div>
          <div class="fee-row"><span>Platform fee (2.5%)</span><strong>GHS 0.61</strong></div>
          <div class="fee-total"><span>Total (via Paystack)</span><span class="amount">GHS 25.00</span></div>
        </div>
        <button type="submit" class="submit-btn mint-btn" id="signup-btn">Register & Pay GHS 25 ‚Üí</button>
      </form>
      <div class="or-divider">Already have an account?</div>
      <div class="switch-link"><button onclick="switchTab('login')">Login to your dashboard</button></div>
    </div>

    <!-- LOGIN -->
    <div class="auth-form" id="form-login">
      <div class="form-title">Welcome Back üëã</div>
      <div class="form-sub">Log in to access your agent dashboard and manage your store.</div>
      <div id="login-err" class="err-box"></div>
      <form onsubmit="handleLogin(event)">
        <div class="flabel">Email Address</div>
        <input class="finput" type="email" id="li-email" placeholder="your@email.com" required/>
        <div class="flabel">Password</div>
        <div class="pw-wrap pw-margin">
          <input class="finput" type="password" id="li-pass" placeholder="Your password" required/>
          <button type="button" class="pw-eye" onclick="togglePw('li-pass')">üëÅ</button>
        </div>
        <button type="submit" class="submit-btn" id="login-btn">Login ‚Üí</button>
      </form>
      <div class="or-divider">Don't have an account?</div>
      <div class="switch-link"><button onclick="switchTab('signup')">Register as an agent</button></div>
    </div>
  </div>
</div>
<footer>¬© 2026 SwiftData GH ‚Äî Powered by Kaysam Growth</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signInAnonymously,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import {
  getFirestore,
  collection, doc, setDoc, getDoc, getDocs,
  deleteDoc, query, where, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey:            "AIzaSyCs7lN4itvWZPichtFLdEE4swNQHSX_j1M",
  authDomain:        "dataplus-a93c7.firebaseapp.com",
  projectId:         "dataplus-a93c7",
  storageBucket:     "dataplus-a93c7.firebasestorage.app",
  messagingSenderId: "1040979049946",
  appId:             "1:1040979049946:web:d5d7957a6c209f56dd94e3",
  measurementId:     "G-GW9DNT0DQ0"
};

const APP_ID = 'swiftdata-main-app';
const app    = initializeApp(firebaseConfig);
const auth   = getAuth(app);
const db     = getFirestore(app);

const AUTH_ERRORS = {
  'auth/email-already-in-use':       'This email is already registered. Please log in instead.',
  'auth/weak-password':              'Password must be at least 6 characters.',
  'auth/invalid-email':              'Please enter a valid email address.',
  'auth/user-not-found':             'No account found with that email address.',
  'auth/wrong-password':             'Incorrect password. Please try again.',
  'auth/invalid-credential':         'Incorrect email or password.',
  'auth/too-many-requests':          'Too many failed attempts. Please wait a few minutes and try again.',
  'auth/user-disabled':              'This account has been disabled. Contact support.',
  'auth/network-request-failed':     'Network error. Check your connection and try again.',
  'auth/operation-not-allowed':      '‚ö†Ô∏è Email/Password sign-in is not enabled. Contact admin.',
  'auth/credential-already-in-use':  'This email is already linked to another account.'
};

function showErr(id, msg) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = msg;
  el.classList.add('show');
}
function hideErr(id) {
  const el = document.getElementById(id);
  if (el) el.classList.remove('show');
}
function setBtn(id, html, disabled = false) {
  const b = document.getElementById(id);
  if (!b) return;
  b.innerHTML = html;
  b.disabled  = disabled;
}

window.switchTab = (tab) => {
  document.getElementById('form-signup').classList.toggle('show', tab === 'signup');
  document.getElementById('form-login').classList.toggle('show', tab === 'login');
  document.getElementById('tab-signup').classList.toggle('active', tab === 'signup');
  document.getElementById('tab-login').classList.toggle('active', tab === 'login');
};

window.sanitizeUsername = (inp) => {
  inp.value = inp.value.toLowerCase().replace(/[^a-z0-9_]/g, '').substring(0, 20);
  const hint = document.getElementById('hint-username');
  if (hint) hint.textContent = inp.value || 'kwame123';
};

window.togglePw = (id) => {
  const i = document.getElementById(id);
  i.type = i.type === 'password' ? 'text' : 'password';
};

function validatePhone(phone) {
  if (!phone) return true;
  return phone.length === 10 && phone.startsWith('0');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üîß FIREBASE AUTH STATE MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _suppressAuthRedirect = false;
const anonAuthReady = signInAnonymously(auth).catch(e => {
  console.warn('Anon signin failed (non-critical):', e.code);
  return false;
});

onAuthStateChanged(auth, async user => {
  if (!user || user.isAnonymous) return;
  if (_suppressAuthRedirect) return;
  
  try {
    const agentDoc = await getDoc(doc(db, 'swiftdata_agents', user.uid));
    if (agentDoc.exists() && agentDoc.data().status === 'active') {
      window.location.href = '/agent.dashboard';
    }
  } catch (e) {
    console.warn('Auth state check error:', e.message);
  }
});

async function safeSignOut() {
  try {
    await signOut(auth);
  } catch (e) {
    console.warn('Sign out error:', e.message);
  }
}

async function restoreAnon() {
  try {
    await signInAnonymously(auth);
  } catch (e) {
    console.warn('Anon restore failed:', e.code);
  }
}

async function isUsernameAvailable(username) {
  try {
    const q = query(collection(db, 'swiftdata_agents'), where('username', '==', username));
    const snap = await getDocs(q);
    return snap.empty;
  } catch (err) {
    console.error('Username check error:', err);
    throw new Error('Could not verify username availability. Please try again.');
  }
}

async function getPaystackKey() {
  try {
    const d = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'config', 'settings_doc'));
    return d.exists() ? (d.data().paystackPublicKey || '') : '';
  } catch (err) {
    console.warn('Could not fetch Paystack key:', err.message);
    return '';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ SIGNUP HANDLER (FIXED)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.handleSignup = async (e) => {
  e.preventDefault();
  hideErr('signup-err');

  const name     = document.getElementById('su-name').value.trim();
  const username = document.getElementById('su-username').value.trim().toLowerCase();
  const email    = document.getElementById('su-email').value.trim();
  const pass     = document.getElementById('su-pass').value;
  const phone    = document.getElementById('su-phone').value.replace(/\D/g, '');

  // Validation
  if (!name) {
    showErr('signup-err', 'Please enter your full name or store name.');
    return;
  }
  if (!username || username.length < 3) {
    showErr('signup-err', 'Username must be at least 3 characters.');
    return;
  }
  if (!/^[a-z0-9_]+$/.test(username)) {
    showErr('signup-err', 'Username can only contain letters, numbers, and underscores.');
    return;
  }
  if (!email) {
    showErr('signup-err', 'Please enter a valid email address.');
    return;
  }
  if (pass.length < 6) {
    showErr('signup-err', 'Password must be at least 6 characters.');
    return;
  }
  if (!validatePhone(phone)) {
    showErr('signup-err', 'Phone must be 10 digits and start with 0 (e.g. 0501234567).');
    return;
  }

  setBtn('signup-btn', '<span class="spin"></span> Checking username‚Ä¶', true);

  try {
    // Step 1: Wait for anonymous auth to complete
    await anonAuthReady;

    // Step 2: Check if username is available
    const available = await isUsernameAvailable(username);
    if (!available) {
      showErr('signup-err', 'That username is already taken. Please choose another.');
      setBtn('signup-btn', 'Register & Pay GHS 25 ‚Üí', false);
      return;
    }

    // Step 3: Get Paystack key (if using payments)
    const psKey = await getPaystackKey();

    setBtn('signup-btn', '<span class="spin"></span> Creating account‚Ä¶', true);
    _suppressAuthRedirect = true;

    // Step 4: Sign out anonymous session and create real account
    await safeSignOut();

    let userCred;
    try {
      userCred = await createUserWithEmailAndPassword(auth, email, pass);
    } catch (authErr) {
      showErr('signup-err', AUTH_ERRORS[authErr.code] || 'Registration error: ' + authErr.message);
      setBtn('signup-btn', 'Register & Pay GHS 25 ‚Üí', false);
      _suppressAuthRedirect = false;
      await restoreAnon();
      return;
    }

    const uid = userCred.user.uid;

    // Step 5: Create agent document in Firestore
    // ‚ö†Ô∏è CRITICAL: If this fails, we need to clean up the Firebase Auth user
    try {
      await setDoc(doc(db, 'swiftdata_agents', uid), {
        uid,
        name,
        username,
        email,
        phone: phone || '',
        status: 'pending',
        walletBalance: 0,
        totalEarned: 0,
        totalOrders: 0,
        createdAt: serverTimestamp(),
        paymentRef: null,
        activatedAt: null
      });
    } catch (firestoreErr) {
      console.error('Firestore write failed:', firestoreErr);
      // Clean up: Delete the Firebase Auth user we just created
      try {
        await userCred.user.delete();
      } catch (delErr) {
        console.warn('Could not delete orphaned auth user:', delErr.message);
      }
      showErr('signup-err', 
        '‚ö†Ô∏è Database error: ' + firestoreErr.message + 
        '\nPlease check your internet connection and try again. If the problem persists, contact support.'
      );
      setBtn('signup-btn', 'Register & Pay GHS 25 ‚Üí', false);
      _suppressAuthRedirect = false;
      await restoreAnon();
      return;
    }

    // Step 6: If no Paystack key, activate immediately (demo mode)
    if (!psKey) {
      try {
        await setDoc(doc(db, 'swiftdata_agents', uid), {
          status: 'active',
          activatedAt: serverTimestamp(),
          paymentRef: 'DEMO_' + Date.now(),
          activationFee: 0,
          isDemoAccount: true
        }, { merge: true });
        window.location.href = '/agent.dashboard';
        return;
      } catch (err) {
        console.error('Demo activation failed:', err);
        showErr('signup-err', '‚ö†Ô∏è Activation failed: ' + err.message);
        setBtn('signup-btn', 'Register & Pay GHS 25 ‚Üí', false);
        _suppressAuthRedirect = false;
        await restoreAnon();
        return;
      }
    }

    // Step 7: Paystack payment flow
    setBtn('signup-btn', '<span class="spin"></span> Loading payment‚Ä¶', true);

    const ps = new PaystackPop();
    ps.newTransaction({
      key: psKey,
      email,
      amount: 2500, // GHS 25.00 in pesewas
      currency: 'GHS',
      ref: 'AGENT_ACT_' + Date.now() + '_' + uid.substring(0, 8),
      metadata: { uid, username, name, type: 'agent_activation' },

      onSuccess: async (tx) => {
        setBtn('signup-btn', '<span class="spin"></span> Activating‚Ä¶', true);
        try {
          await setDoc(doc(db, 'swiftdata_agents', uid), {
            status: 'active',
            activatedAt: serverTimestamp(),
            paymentRef: tx.reference,
            activationFee: 25
          }, { merge: true });
          window.location.href = '/agent.dashboard';
        } catch (err) {
          console.error('Activation update failed:', err);
          _suppressAuthRedirect = false;
          showErr('signup-err',
            '‚ö†Ô∏è Payment received but activation failed. Contact support with ref: ' + tx.reference
          );
          setBtn('signup-btn', 'Register & Pay GHS 25 ‚Üí', false);
        }
      },

      onCancel: async () => {
        try {
          await deleteDoc(doc(db, 'swiftdata_agents', uid));
        } catch (er) {
          console.warn('Could not delete Firestore doc:', er.message);
        }
        try {
          await userCred.user.delete();
        } catch (er) {
          console.warn('Could not delete auth user:', er.message);
        }
        await safeSignOut();
        _suppressAuthRedirect = false;
        await restoreAnon();
        setBtn('signup-btn', 'Register & Pay GHS 25 ‚Üí', false);
        showErr('signup-err', 'Payment cancelled. Account creation cancelled. Please try again.');
      }
    });

  } catch (err) {
    console.error('Signup error:', err);
    showErr('signup-err', 'An unexpected error occurred: ' + err.message);
    setBtn('signup-btn', 'Register & Pay GHS 25 ‚Üí', false);
    _suppressAuthRedirect = false;
    await restoreAnon();
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚úÖ LOGIN HANDLER (FIXED)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.handleLogin = async (e) => {
  e.preventDefault();
  hideErr('login-err');

  const email = document.getElementById('li-email').value.trim();
  const pass  = document.getElementById('li-pass').value;

  if (!email || !pass) {
    showErr('login-err', 'Please enter email and password.');
    return;
  }

  setBtn('login-btn', '<span class="spin"></span> Logging in‚Ä¶', true);
  _suppressAuthRedirect = true;

  try {
    // Clear any existing sessions
    await safeSignOut();

    // Attempt Firebase Auth sign-in
    let cred;
    try {
      cred = await signInWithEmailAndPassword(auth, email, pass);
    } catch (authErr) {
      showErr('login-err', AUTH_ERRORS[authErr.code] || 'Login error: ' + authErr.message);
      setBtn('login-btn', 'Login ‚Üí', false);
      _suppressAuthRedirect = false;
      await restoreAnon();
      return;
    }

    const uid = cred.user.uid;

    // Check if Firestore agent document exists
    let agentDoc;
    try {
      agentDoc = await getDoc(doc(db, 'swiftdata_agents', uid));
    } catch (firestoreErr) {
      console.error('Firestore read error:', firestoreErr);
      await safeSignOut();
      showErr('login-err', '‚ö†Ô∏è Database connection error: ' + firestoreErr.message);
      setBtn('login-btn', 'Login ‚Üí', false);
      _suppressAuthRedirect = false;
      await restoreAnon();
      return;
    }

    // If no agent document, user was created in auth but not in database
    if (!agentDoc.exists()) {
      await safeSignOut();
      showErr('login-err', 
        '‚ö†Ô∏è Your account was partially created. Please contact support to complete setup.\n' +
        'Reference: ' + uid.substring(0, 8)
      );
      setBtn('login-btn', 'Login ‚Üí', false);
      _suppressAuthRedirect = false;
      await restoreAnon();
      return;
    }

    const { status } = agentDoc.data();

    if (status === 'banned') {
      await safeSignOut();
      showErr('login-err', 'Your account has been suspended. Contact support on WhatsApp.');
      setBtn('login-btn', 'Login ‚Üí', false);
      _suppressAuthRedirect = false;
      await restoreAnon();
      return;
    }

    if (status === 'pending') {
      await safeSignOut();
      showErr('login-err', 'Your account is pending activation. Complete the GHS 25 payment to activate.');
      setBtn('login-btn', 'Login ‚Üí', false);
      _suppressAuthRedirect = false;
      await restoreAnon();
      return;
    }

    // Active agent ‚Äî redirect to dashboard
    _suppressAuthRedirect = false;
    window.location.href = '/agent.dashboard';

  } catch (err) {
    console.error('Login unexpected error:', err);
    showErr('login-err', 'An unexpected error occurred: ' + err.message);
    setBtn('login-btn', 'Login ‚Üí', false);
    _suppressAuthRedirect = false;
    await safeSignOut();
    await restoreAnon();
  }
};
</script>
</body>
</html>
