<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SwiftData Agent Store</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<script src="https://js.paystack.co/v2/inline.js"></script>
<style>
:root{--blue:#0051ff;--mint:#00e5b0;--offwht:#f4f7ff;--muted:#6b7a99;--card:#fff;--yellow:#f59e0b;--green:#22c55e;}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--offwht);color:#0a0f1e;min-height:100vh;display:flex;flex-direction:column;}
nav{height:60px;display:flex;align-items:center;background:#fff;border-bottom:1.5px solid rgba(0,81,255,.1);padding:0 2rem;}
.logo{font-weight:800;font-size:1.1rem;}.logo span{color:var(--blue);}
.nav-right{margin-left:auto;}
main{flex:1;padding:3rem 2rem;max-width:1100px;margin:0 auto;width:100%;}
.store-header{text-align:center;margin-bottom:3rem;}
.store-header h1{font-weight:800;font-size:2rem;margin-bottom:.5rem;}
.store-header p{color:var(--muted);font-size:.95rem;}
.agent-info{background:linear-gradient(135deg,var(--blue),#7c3aed);color:#fff;border-radius:18px;padding:1.5rem;margin-bottom:2.5rem;text-align:center;}
.agent-info h2{font-weight:800;font-size:1.3rem;margin-bottom:.3rem;}
.bundle-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1rem;margin-bottom:2rem;}
.bundle-card{background:#fff;border-radius:16px;border:2px solid rgba(0,81,255,.1);padding:1.25rem;cursor:pointer;transition:all .2s;}
.bundle-card:hover{border-color:var(--blue);box-shadow:0 10px 30px rgba(0,81,255,.15);}
.bundle-card.selected{border-color:var(--blue);background:rgba(0,81,255,.04);}
.net-badge{display:inline-block;font-size:.65rem;font-weight:800;text-transform:uppercase;letter-spacing:1px;background:rgba(0,81,255,.1);color:var(--blue);padding:.2rem .6rem;border-radius:50px;margin-bottom:.5rem;}
.bundle-size{font-weight:800;font-size:1.5rem;margin-bottom:.3rem;}
.bundle-price{font-weight:800;font-size:1.2rem;color:var(--blue);}
.checkout-panel{background:#fff;border-radius:18px;border:1.5px solid rgba(0,81,255,.1);padding:2rem;margin-bottom:2rem;display:none;}
.checkout-panel.show{display:block;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem;}
.form-label{font-size:.7rem;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:.4rem;display:block;}
.form-input{padding:.75rem 1rem;border:2px solid rgba(0,0,0,.08);border-radius:12px;font-family:inherit;font-size:.95rem;outline:none;}
.form-input:focus{border-color:var(--blue);box-shadow:0 0 0 4px rgba(0,81,255,.08);}
.price-breakdown{background:rgba(0,81,255,.04);border-radius:12px;padding:1rem;margin-bottom:1.5rem;font-size:.85rem;}
.price-line{display:flex;justify-content:space-between;margin-bottom:.5rem;}
.price-total{display:flex;justify-content:space-between;margin-top:.5rem;border-top:2px solid rgba(0,81,255,.15);padding-top:.5rem;font-weight:800;}
.checkout-btn{width:100%;padding:1rem;background:var(--blue);color:#fff;border:none;border-radius:12px;font-family:inherit;font-weight:800;font-size:1rem;cursor:pointer;transition:all .2s;}
.checkout-btn:hover{transform:translateY(-2px);box-shadow:0 10px 28px rgba(0,81,255,.35);}
.checkout-btn:disabled{opacity:.5;}
.success-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);z-index:200;display:none;align-items:center;justify-content:center;padding:1.5rem;}
.success-modal.show{display:flex;}
.success-box{background:#fff;border-radius:24px;padding:2.5rem;max-width:480px;width:100%;text-align:center;}
.success-icon{width:80px;height:80px;border-radius:50%;background:rgba(34,197,94,.1);color:var(--green);display:flex;align-items:center;justify-content:center;font-size:2.5rem;margin:0 auto 1.5rem;}
.success-box h3{font-weight:800;font-size:1.4rem;margin-bottom:.5rem;}
.success-ref{background:rgba(0,81,255,.06);border:2px solid rgba(0,81,255,.15);border-radius:12px;padding:1rem;margin-bottom:1.25rem;}
.ref-code{font-weight:800;font-size:1.5rem;color:var(--blue);letter-spacing:2px;}
.modal-btn{width:100%;padding:.9rem;background:var(--blue);color:#fff;border:none;border-radius:12px;font-family:inherit;font-weight:700;cursor:pointer;}
@media(max-width:640px){.form-row{grid-template-columns:1fr;}}
</style>
</head>
<body>

<nav>
  <div class="logo">SwiftData<span>GH</span></div>
  <div class="nav-right">
    <a href="/" style="text-decoration:none;font-weight:700;font-size:.85rem;color:var(--muted);">‚Üê Back</a>
  </div>
</nav>

<main>
  <div class="store-header">
    <h1 id="agent-name-header">Agent Store</h1>
    <p id="agent-username-display">@username</p>
  </div>

  <div class="agent-info">
    <h2>Welcome! üéâ</h2>
    <p>Shop from our agent's store</p>
  </div>

  <div id="products-container">
    <div class="bundle-grid" id="bundle-grid">
      <div style="grid-column:1/-1;padding:3rem;text-align:center;color:var(--muted);">Loading...</div>
    </div>
  </div>

  <div class="success-modal" id="success-modal">
    <div class="success-box">
      <div class="success-icon">‚úì</div>
      <h3>Payment Successful!</h3>
      <p>Sending to <strong id="success-phone" style="color:var(--blue);"></strong></p>
      <div class="success-ref">
        <div style="font-size:.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:.3rem;">Order Reference</div>
        <div class="ref-code" id="success-ref">SdG-001</div>
      </div>
      <p style="font-size:.85rem;color:var(--muted);margin-bottom:1.5rem;">Delivered in 5-30 minutes.</p>
      <button class="modal-btn" onclick="closeSuccess()">Done</button>
    </div>
  </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, getDoc, onSnapshot, increment, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCs7lN4itvWZPichtFLdEE4swNQHSX_j1M",
  authDomain: "dataplus-a93c7.firebaseapp.com",
  projectId: "dataplus-a93c7",
  storageBucket: "dataplus-a93c7.firebasestorage.app",
  messagingSenderId: "1040979049946",
  appId: "1:1040979049946:web:d5d7957a6c209f56dd94e3"
};

const FEE_RATE = 0.025;
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let S = {agent: null, products: []};

function genRef() {
  const num = ((Date.now() % 900) + 100);
  return `SdG-${String(num).padStart(3, '0')}`;
}

window.selectProduct = (id) => {
  const alreadySelected = S.selectedProduct?.id === id;
  S.selectedProduct = alreadySelected ? null : S.products.find(p => p.id === id);
  S.phone = '';
  S.phoneConfirm = '';
  renderProducts();
};

window.updatePhone = (val, field) => {
  S[field] = val.replace(/\D/g, '').substring(0, 10);
  const btn = document.getElementById('co-btn');
  if (btn) btn.disabled = !(S.phone.length === 10 && S.phone === S.phoneConfirm);
};

window.initPayment = async () => {
  if (!S.selectedProduct || !S.phone || !S.agent) return;
  
  const btn = document.getElementById('co-btn');
  btn.disabled = true;
  btn.textContent = '‚è≥ Processing...';

  try {
    const price = S.selectedProduct.storePrice;
    const total = price * (1 + FEE_RATE);
    const email = `customer_${S.phone}@swiftdata.com`;

    if (!window.PaystackPop) {
      await createOrder('DEMO_' + Date.now());
      return;
    }

    const ps = new PaystackPop();
    const ref = 'AG_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
    
    ps.newTransaction({
      key: 'pk_live_xxx', // Mock - will use demo mode
      email,
      amount: Math.round(total * 100),
      currency: 'GHS',
      ref,
      onSuccess: async (tx) => { await createOrder(tx.reference); },
      onCancel: () => {
        btn.disabled = false;
        btn.textContent = 'Checkout ‚Üí';
      }
    });
  } catch (e) {
    console.error('Payment error:', e);
    // Fallback to demo
    await createOrder('DEMO_' + Date.now());
  }
};

async function createOrder(payRef) {
  try {
    const price = S.selectedProduct.storePrice;
    const total = price * (1 + FEE_RATE);
    const ref = genRef();

    await addDoc(collection(db, 'orders'), {
      orderRef: ref,
      network: S.selectedProduct.network,
      size: S.selectedProduct.size,
      price: parseFloat(total.toFixed(2)),
      recipient: S.phone,
      status: 'Pending',
      createdAt: serverTimestamp(),
      type: 'agent_customer',
      agentId: S.agent.uid,
      agentUsername: S.agent.username,
      agentProfit: S.selectedProduct.markup || 0
    });

    // Try to credit agent wallet
    if ((S.selectedProduct.markup || 0) > 0) {
      try {
        await updateDoc(doc(db, 'swiftdata_agents', S.agent.uid), {
          walletBalance: increment(S.selectedProduct.markup),
          totalEarned: increment(S.selectedProduct.markup),
          totalOrders: increment(1)
        });
      } catch (err) {
        console.error('Wallet update failed (order still created):', err);
      }
    }

    document.getElementById('success-phone').textContent = S.phone;
    document.getElementById('success-ref').textContent = ref;
    document.getElementById('success-modal').classList.add('show');
    
    S.selectedProduct = null;
    S.phone = '';
    S.phoneConfirm = '';
    renderProducts();
  } catch (err) {
    console.error('Order error:', err);
    alert('Order failed: ' + err.message);
    const btn = document.getElementById('co-btn');
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'Checkout ‚Üí';
    }
  }
}

window.closeSuccess = () => {
  document.getElementById('success-modal').classList.remove('show');
};

function renderProducts() {
  const grid = document.getElementById('bundle-grid');
  if (!S.products.length) {
    grid.innerHTML = '<div style="grid-column:1/-1;padding:3rem;text-align:center;color:var(--muted);">No products yet.</div>';
    return;
  }

  let html = '';
  S.products.forEach(p => {
    const sel = S.selectedProduct?.id === p.id;
    html += `<div class="bundle-card${sel ? ' selected' : ''}" onclick="selectProduct('${p.id}')">
      <div class="net-badge">${p.network}</div>
      <div class="bundle-size">${p.size}</div>
      <div style="font-size:.85rem;color:var(--muted);margin-bottom:.5rem;">${p.type || 'Standard'}</div>
      <div class="bundle-price">GHS ${p.storePrice.toFixed(2)}</div>
    </div>`;
  });

  if (S.selectedProduct) {
    const price = S.selectedProduct.storePrice;
    const fee = price * FEE_RATE;
    const total = price + fee;
    const ok = S.phone.length === 10 && S.phone === S.phoneConfirm;

    html += `<div style="grid-column:1/-1;">
      <div class="checkout-panel show">
        <div style="font-weight:800;font-size:1.05rem;margin-bottom:1.2rem;">üì± Checkout</div>
        <div class="form-row">
          <div><label class="form-label">Phone</label><input class="form-input" type="tel" placeholder="05XXXXXXXX" maxlength="10"
            oninput="updatePhone(this.value,'phone')" value="${S.phone}" inputmode="numeric"/></div>
          <div><label class="form-label">Confirm</label><input class="form-input" type="tel" placeholder="05XXXXXXXX" maxlength="10"
            oninput="updatePhone(this.value,'phoneConfirm')" value="${S.phoneConfirm}" inputmode="numeric"/></div>
        </div>
        <div class="price-breakdown">
          <div class="price-line"><span>Price:</span><span>GHS ${price.toFixed(2)}</span></div>
          <div class="price-line"><span>Fee (2.5%):</span><span>GHS ${fee.toFixed(2)}</span></div>
          <div class="price-total"><span>Total:</span><span>GHS ${total.toFixed(2)}</span></div>
        </div>
        <button id="co-btn" class="checkout-btn" onclick="initPayment()" ${ok ? '' : 'disabled'}>Checkout ‚Üí</button>
      </div>
    </div>`;
  }

  grid.innerHTML = html;
}

onAuthStateChanged(auth, async (user) => {
  if (!user) return;

  try {
    const agentUsername = new URLSearchParams(window.location.search).get('agent');
    if (!agentUsername) {
      document.getElementById('products-container').innerHTML = '<div style="padding:3rem;text-align:center;color:var(--muted);">Invalid agent link.</div>';
      return;
    }

    // Find agent by username
    onSnapshot(collection(db, 'swiftdata_agents'), (snap) => {
      const agentDoc = snap.docs.find(d => d.data().username === agentUsername);
      if (!agentDoc) {
        document.getElementById('products-container').innerHTML = '<div style="padding:3rem;text-align:center;color:var(--muted);">Agent not found.</div>';
        return;
      }

      S.agent = {uid: agentDoc.id, ...agentDoc.data()};
      document.getElementById('agent-name-header').textContent = S.agent.name;
      document.getElementById('agent-username-display').textContent = '@' + S.agent.username;

      // Load agent products
      onSnapshot(collection(db, 'swiftdata_agents', agentDoc.id, 'products'), (snap) => {
        S.products = snap.docs.map(d => ({id: d.id, ...d.data()}));
        renderProducts();
      }, (err) => {
        console.error('Products error:', err);
        document.getElementById('products-container').innerHTML = '<div style="padding:3rem;text-align:center;color:var(--muted);">Error loading products.</div>';
      });
    }, (err) => console.error('Agents error:', err));

  } catch (err) {
    console.error('Setup error:', err);
    document.getElementById('products-container').innerHTML = '<div style="padding:3rem;text-align:center;color:var(--muted);">Error loading store.</div>';
  }
});

signInAnonymously(auth).catch(e => console.error('Auth error:', e));
</script>
</body>
</html>
