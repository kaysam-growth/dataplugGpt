<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DATAPLUS GH | Premium Data Services</title>
    
    <!-- Tailwind CSS for Modern UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
    
    <!-- Paystack -->
    <script src="https://js.paystack.co/v1/inline.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        brand: { 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a' },
                        dark: { 800: '#0f172a', 900: '#020617' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #020617; color: #f8fafc; }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="min-h-screen flex flex-col font-sans">

    <!-- Navbar -->
    <nav class="glass-panel sticky top-0 z-50 px-6 py-4 flex justify-between items-center shadow-lg border-b border-slate-800">
        <div class="flex items-center gap-3 cursor-pointer" onclick="app.router('home')">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-blue-500/20 shadow-lg">
                <i class="fa-solid fa-wifi text-white text-lg"></i>
            </div>
            <h1 class="text-2xl font-bold tracking-tight text-white">DATAPLUS <span class="text-blue-500">GH</span></h1>
        </div>
        
        <div class="hidden md:flex items-center gap-6">
            <button onclick="app.router('home')" class="hover:text-blue-400 transition">Shop</button>
            <button onclick="app.router('agent-landing')" class="hover:text-blue-400 transition">Become an Agent</button>
            <div id="auth-buttons" class="flex gap-3">
                <!-- Injected via JS -->
            </div>
        </div>

        <!-- Mobile Menu Button -->
        <button class="md:hidden text-2xl" onclick="toggleMobileMenu()"><i class="fa-solid fa-bars"></i></button>
    </nav>

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu" class="fixed inset-0 bg-dark-900/95 z-40 hidden flex-col justify-center items-center gap-8 text-xl">
        <button onclick="app.router('home'); toggleMobileMenu()">Shop</button>
        <button onclick="app.router('agent-landing'); toggleMobileMenu()">Agents</button>
        <button onclick="toggleMobileMenu()" class="text-red-400"><i class="fa-solid fa-xmark"></i> Close</button>
    </div>

    <!-- Main Content Area -->
    <main id="app-root" class="flex-grow p-4 md:p-8 max-w-7xl mx-auto w-full relative">
        <!-- Views will be injected here -->
        <div class="flex justify-center mt-20"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500"></i></div>
    </main>

    <!-- Footer -->
    <footer class="mt-auto border-t border-slate-800 bg-dark-900 py-8 text-center text-slate-400 text-sm">
        <p>&copy; 2024 DATAPLUS GH. All rights reserved.</p>
        <p class="mt-2 text-xs">Reliable Data. Fast Delivery.</p>
    </footer>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-3"></div>

    <!-- ==========================================
         APPLICATION LOGIC
    =========================================== -->
    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyCs7lN4itvWZPichtFLdEE4swNQHSX_j1M", // Replace if needed
                authDomain: "dataplus-a93c7.firebaseapp.com",
                projectId: "dataplus-a93c7",
                storageBucket: "dataplus-a93c7.firebasestorage.app",
                messagingSenderId: "1040979049946",
                appId: "1:1040979049946:web:d5d7957a6c209f56dd94e3"
            },
            paystackKey: "pk_live_6d3e8e97e00804864eb1cb0607fe40d32b5af8a9", // Replace with "pk_live_..." for production
            agentFee: 10,
            currency: "GHS"
        };

        // --- FIREBASE INIT ---
        if (!firebase.apps.length) {
            firebase.initializeApp(CONFIG.firebase);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- STATE MANAGEMENT ---
        const state = {
            user: null,
            userData: null, // Stores Firestore user profile
            products: [],
            currentView: 'home'
        };

        // --- APP CONTROLLER ---
        const app = {
            init: async () => {
                // Check URL for Agent Referral
                const params = new URLSearchParams(window.location.search);
                const agentRef = params.get("ref");
                if (agentRef) localStorage.setItem("dataplus_agent_ref", agentRef);

                // Auth Listener
                auth.onAuthStateChanged(async (user) => {
                    state.user = user;
                    if (user) {
                        // Fetch extended profile
                        const doc = await db.collection("users").doc(user.uid).get();
                        state.userData = doc.exists ? doc.data() : null;
                    } else {
                        state.userData = null;
                    }
                    app.renderNav();
                    // If on a protected route and logged out, go home
                    if (!user && (state.currentView === 'dashboard' || state.currentView === 'admin')) {
                        app.router('home');
                    } else if (state.currentView === 'loading') {
                        app.router('home');
                    }
                });
                
                // Load Products
                await app.fetchProducts();
                app.router('home'); // Initial Load
            },

            fetchProducts: async () => {
                const snap = await db.collection("products").where("active", "==", true).get();
                state.products = snap.docs.map(d => ({id: d.id, ...d.data()}));
            },

            // --- ROUTER ---
            router: (viewName) => {
                state.currentView = viewName;
                const root = document.getElementById('app-root');
                window.scrollTo(0,0);
                
                switch(viewName) {
                    case 'home':
                        root.innerHTML = views.home();
                        break;
                    case 'agent-landing':
                        root.innerHTML = views.agentLanding();
                        break;
                    case 'login':
                        root.innerHTML = views.login();
                        break;
                    case 'register':
                        root.innerHTML = views.register();
                        break;
                    case 'dashboard':
                        if(!state.user) { app.router('login'); return; }
                        root.innerHTML = `<div class="text-center mt-10"><i class="fa-solid fa-spinner fa-spin text-2xl"></i> Loading Dashboard...</div>`;
                        views.renderDashboard(root);
                        break;
                    case 'admin':
                        if(!state.userData?.isAdmin) { 
                            showToast("Access Denied", "error"); 
                            app.router('home'); 
                            return; 
                        }
                        views.renderAdmin(root);
                        break;
                    default:
                        root.innerHTML = views.home();
                }
            },

            renderNav: () => {
                const container = document.getElementById('auth-buttons');
                if (state.user) {
                    let dashboardLink = "app.router('dashboard')";
                    let dashboardText = "Dashboard";
                    
                    if (state.userData?.isAdmin) {
                        dashboardLink = "app.router('admin')";
                        dashboardText = "Admin Panel";
                    }

                    container.innerHTML = `
                        <button onclick="${dashboardLink}" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-full font-semibold transition text-sm shadow-lg shadow-blue-500/30">
                            ${dashboardText}
                        </button>
                        <button onclick="auth.signOut()" class="text-slate-400 hover:text-white transition"><i class="fa-solid fa-right-from-bracket"></i></button>
                    `;
                } else {
                    container.innerHTML = `
                        <button onclick="app.router('login')" class="text-slate-300 hover:text-white font-medium">Login</button>
                        <button onclick="app.router('agent-landing')" class="bg-white text-blue-900 px-5 py-2 rounded-full font-bold hover:bg-slate-200 transition text-sm">Join</button>
                    `;
                }
            }
        };

        // --- VIEWS ---
        const views = {
            home: () => `
                <div class="animate-fade-in space-y-12">
                    <!-- Hero -->
                    <div class="text-center space-y-4 py-10">
                        <span class="bg-blue-500/10 text-blue-400 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider border border-blue-500/20">Fastest Delivery in Ghana</span>
                        <h1 class="text-5xl md:text-7xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white via-slate-200 to-slate-400">
                            Buy Data Bundles <br class="hidden md:block" /> Instantly.
                        </h1>
                        <p class="text-slate-400 max-w-2xl mx-auto text-lg">
                            Secure payments, instant top-up, and the best rates for MTN, Vodafone, and AT.
                        </p>
                    </div>

                    <!-- Products Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${state.products.length > 0 ? state.products.map(p => `
                            <div class="glass-panel p-6 rounded-2xl hover:border-blue-500/50 transition duration-300 group relative overflow-hidden">
                                <div class="absolute top-0 right-0 w-20 h-20 bg-blue-500/10 rounded-bl-full -mr-4 -mt-4 transition group-hover:bg-blue-500/20"></div>
                                <h3 class="text-xl font-bold mb-1">${p.name}</h3>
                                <div class="text-3xl font-bold text-blue-400 mb-4">GHS ${p.price}</div>
                                <ul class="text-sm text-slate-400 mb-6 space-y-2">
                                    <li><i class="fa-solid fa-check text-green-500 mr-2"></i> No Expiry</li>
                                    <li><i class="fa-solid fa-bolt text-yellow-500 mr-2"></i> Instant Delivery</li>
                                </ul>
                                <button onclick="actions.initiatePurchase('${p.id}', '${p.name}', ${p.price})" class="w-full bg-slate-800 hover:bg-blue-600 text-white font-bold py-3 rounded-xl transition border border-slate-700 hover:border-blue-500">
                                    Buy Now
                                </button>
                            </div>
                        `).join('') : '<div class="col-span-3 text-center text-slate-500 py-10">Loading packages...</div>'}
                    </div>

                    <!-- Trust Indicators -->
                    <div class="flex justify-center gap-8 opacity-50 grayscale hover:grayscale-0 transition duration-500 py-8">
                        <i class="fa-brands fa-cc-visa text-4xl"></i>
                        <i class="fa-brands fa-cc-mastercard text-4xl"></i>
                        <i class="fa-solid fa-mobile-screen-button text-4xl"></i>
                    </div>
                </div>
            `,

            agentLanding: () => `
                <div class="max-w-4xl mx-auto text-center animate-fade-in py-10">
                    <h2 class="text-4xl font-bold mb-6">Partner with DATAPLUS</h2>
                    <p class="text-xl text-slate-400 mb-10">Earn up to <span class="text-green-400 font-bold">40% profit</span> on every data bundle you sell.</p>
                    
                    <div class="grid md:grid-cols-3 gap-6 mb-12 text-left">
                        <div class="glass-panel p-6 rounded-xl">
                            <i class="fa-solid fa-wallet text-3xl text-blue-400 mb-4"></i>
                            <h4 class="font-bold text-lg">High Margins</h4>
                            <p class="text-slate-400 text-sm">Set your own prices or earn standard commissions.</p>
                        </div>
                        <div class="glass-panel p-6 rounded-xl">
                            <i class="fa-solid fa-bolt text-3xl text-yellow-400 mb-4"></i>
                            <h4 class="font-bold text-lg">Instant Payouts</h4>
                            <p class="text-slate-400 text-sm">Withdraw your earnings to Mobile Money anytime.</p>
                        </div>
                        <div class="glass-panel p-6 rounded-xl">
                            <i class="fa-solid fa-chart-line text-3xl text-green-400 mb-4"></i>
                            <h4 class="font-bold text-lg">Track Sales</h4>
                            <p class="text-slate-400 text-sm">Real-time dashboard to monitor your performance.</p>
                        </div>
                    </div>

                    <div class="glass-panel p-8 rounded-2xl max-w-md mx-auto border-blue-500/30 shadow-[0_0_40px_rgba(59,130,246,0.1)]">
                        <h3 class="text-2xl font-bold mb-2">Join the Team</h3>
                        <p class="text-slate-400 mb-6">One-time registration fee: <b>GHS ${CONFIG.agentFee}</b></p>
                        
                        <div class="space-y-4">
                            <input type="email" id="signup-email" placeholder="Email Address" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none transition">
                            <input type="password" id="signup-pass" placeholder="Create Password" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none transition">
                            <input type="text" id="signup-name" placeholder="Full Name" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none transition">
                            
                            <button onclick="actions.signupAgent()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3 rounded-lg shadow-lg transition transform hover:scale-[1.02]">
                                Pay GHS ${CONFIG.agentFee} & Join
                            </button>
                        </div>
                        <p class="mt-4 text-sm text-slate-500">Already an agent? <a href="#" onclick="app.router('login')" class="text-blue-400 hover:underline">Login here</a></p>
                    </div>
                </div>
            `,

            login: () => `
                <div class="max-w-md mx-auto mt-10 animate-fade-in">
                    <div class="glass-panel p-8 rounded-2xl">
                        <h2 class="text-2xl font-bold mb-6 text-center">Welcome Back</h2>
                        <div class="space-y-4">
                            <input type="email" id="login-email" placeholder="Email" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none">
                            <input type="password" id="login-pass" placeholder="Password" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none">
                            <button onclick="actions.login()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition">Login</button>
                        </div>
                        <p class="mt-6 text-center text-sm text-slate-500">
                            Don't have an account? <button onclick="app.router('agent-landing')" class="text-blue-400 hover:underline">Register</button>
                        </p>
                    </div>
                </div>
            `,

            renderDashboard: async (container) => {
                if(!state.userData) return;
                
                // Get fresh data
                const userDoc = await db.collection("users").doc(state.user.uid).get();
                const userData = userDoc.data();
                
                // Get orders referred by this agent
                const salesSnap = await db.collection("orders").where("agentId", "==", state.user.uid).get();
                const salesCount = salesSnap.size;

                container.innerHTML = `
                    <div class="animate-fade-in space-y-6">
                        <!-- Header -->
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h2 class="text-3xl font-bold">Dashboard</h2>
                                <p class="text-slate-400">Welcome back, ${userData.name}</p>
                            </div>
                            <div class="bg-blue-900/30 border border-blue-500/30 px-4 py-2 rounded-lg flex items-center gap-3">
                                <span class="text-sm text-blue-200">Referral ID:</span>
                                <code class="font-mono font-bold text-white bg-black/20 px-2 py-1 rounded">${userData.agentCode}</code>
                                <button onclick="actions.copyLink('${userData.agentCode}')" class="text-blue-400 hover:text-white"><i class="fa-regular fa-copy"></i></button>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="glass-panel p-6 rounded-xl border-l-4 border-green-500">
                                <p class="text-slate-400 text-sm">Wallet Balance</p>
                                <h3 class="text-3xl font-bold text-white">GHS ${userData.balance?.toFixed(2) || '0.00'}</h3>
                                <button onclick="actions.requestWithdrawal(${userData.balance})" class="mt-4 text-xs bg-slate-800 hover:bg-slate-700 px-3 py-1 rounded text-white border border-slate-600 transition">Withdraw Funds</button>
                            </div>
                            <div class="glass-panel p-6 rounded-xl border-l-4 border-blue-500">
                                <p class="text-slate-400 text-sm">Total Sales</p>
                                <h3 class="text-3xl font-bold text-white">${salesCount}</h3>
                            </div>
                            <div class="glass-panel p-6 rounded-xl border-l-4 border-purple-500">
                                <p class="text-slate-400 text-sm">Commission Rate</p>
                                <h3 class="text-3xl font-bold text-white">${userData.commission || 10}%</h3>
                            </div>
                        </div>

                        <!-- Tools -->
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="glass-panel p-6 rounded-xl">
                                <h4 class="font-bold text-lg mb-4">Generate Link</h4>
                                <p class="text-sm text-slate-400 mb-4">Send this link to customers. You earn commission automatically when they buy.</p>
                                <div class="flex gap-2">
                                    <input type="text" readonly value="${window.location.origin}?ref=${userData.agentCode}" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-slate-300 text-sm">
                                    <button onclick="actions.copyLink('${userData.agentCode}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded transition">Copy</button>
                                </div>
                            </div>

                            <div class="glass-panel p-6 rounded-xl">
                                <h4 class="font-bold text-lg mb-4">Recent Transactions</h4>
                                <div class="text-sm text-slate-400">
                                    ${salesCount === 0 ? 'No sales yet. Start sharing your link!' : 'Check "My Orders" tab (Coming Soon)'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderAdmin: async (container) => {
                // Fetch Data needed for admin
                const products = state.products;
                const usersSnap = await db.collection("users").where("role", "==", "agent").get();
                const agentsCount = usersSnap.size;
                const ordersSnap = await db.collection("orders").orderBy("createdAt", "desc").limit(20).get();
                const withdrawalSnap = await db.collection("withdrawals").where("status", "==", "pending").get();

                container.innerHTML = `
                    <div class="animate-fade-in space-y-8">
                        <div class="flex justify-between items-center">
                            <h2 class="text-3xl font-bold text-white"><i class="fa-solid fa-shield-halved text-blue-500 mr-2"></i> Admin Panel</h2>
                            <button onclick="app.router('home')" class="text-slate-400 hover:text-white">Exit Admin</button>
                        </div>

                        <!-- KPI -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-slate-800 p-4 rounded-lg">
                                <div class="text-slate-400 text-xs uppercase">Agents</div>
                                <div class="text-2xl font-bold">${agentsCount}</div>
                            </div>
                             <div class="bg-slate-800 p-4 rounded-lg">
                                <div class="text-slate-400 text-xs uppercase">Products</div>
                                <div class="text-2xl font-bold">${products.length}</div>
                            </div>
                            <div class="bg-slate-800 p-4 rounded-lg">
                                <div class="text-slate-400 text-xs uppercase">Pending Withdrawals</div>
                                <div class="text-2xl font-bold text-yellow-400">${withdrawalSnap.size}</div>
                            </div>
                        </div>

                        <div class="grid lg:grid-cols-2 gap-8">
                            <!-- Product Management -->
                            <div class="glass-panel p-6 rounded-xl">
                                <h3 class="font-bold text-xl mb-4 border-b border-slate-700 pb-2">Manage Products</h3>
                                <form onsubmit="event.preventDefault(); actions.adminAddProduct()" class="flex gap-2 mb-6">
                                    <input id="new-prod-name" placeholder="Name (e.g. 5GB MTN)" class="bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm w-full">
                                    <input id="new-prod-price" type="number" step="0.01" placeholder="Price" class="bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm w-24">
                                    <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded"><i class="fa-solid fa-plus"></i></button>
                                </form>
                                <div class="space-y-2 max-h-60 overflow-y-auto pr-2">
                                    ${products.map(p => `
                                        <div class="flex justify-between items-center bg-slate-800/50 p-2 rounded">
                                            <span>${p.name}</span>
                                            <div class="flex items-center gap-3">
                                                <span class="font-mono text-blue-400">GHS ${p.price}</span>
                                                <button onclick="actions.adminDeleteProduct('${p.id}')" class="text-red-400 hover:text-red-300"><i class="fa-solid fa-trash"></i></button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Withdrawal Requests -->
                            <div class="glass-panel p-6 rounded-xl">
                                <h3 class="font-bold text-xl mb-4 border-b border-slate-700 pb-2">Withdrawal Requests</h3>
                                ${withdrawalSnap.size === 0 ? '<p class="text-slate-500 italic">No pending requests.</p>' : 
                                    `<div class="space-y-3">
                                        ${withdrawalSnap.docs.map(doc => {
                                            const w = doc.data();
                                            return `
                                            <div class="bg-slate-800 p-3 rounded flex justify-between items-center">
                                                <div>
                                                    <div class="font-bold">GHS ${w.amount}</div>
                                                    <div class="text-xs text-slate-400">Agent: ${w.agentId.substring(0,5)}...</div>
                                                </div>
                                                <button onclick="actions.adminApproveWithdrawal('${doc.id}', '${w.agentId}', ${w.amount})" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded">Mark Paid</button>
                                            </div>
                                            `
                                        }).join('')}
                                    </div>`
                                }
                            </div>
                        </div>

                        <!-- Recent Orders -->
                        <div class="glass-panel p-6 rounded-xl">
                            <h3 class="font-bold text-xl mb-4">Recent Orders</h3>
                            <table class="w-full text-left text-sm text-slate-400">
                                <thead class="border-b border-slate-700 text-slate-200">
                                    <tr>
                                        <th class="pb-2">Product</th>
                                        <th class="pb-2">Price</th>
                                        <th class="pb-2">Status</th>
                                        <th class="pb-2">Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${ordersSnap.docs.map(doc => {
                                        const o = doc.data();
                                        return `
                                            <tr class="border-b border-slate-800/50">
                                                <td class="py-2 text-white">${o.product}</td>
                                                <td class="py-2">GHS ${o.price}</td>
                                                <td class="py-2"><span class="bg-green-500/10 text-green-500 px-2 rounded text-xs">PAID</span></td>
                                                <td class="py-2">${o.createdAt ? new Date(o.createdAt.seconds * 1000).toLocaleDateString() : '-'}</td>
                                            </tr>
                                        `
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
        };

        // --- ACTIONS & LOGIC ---
        const actions = {
            login: async () => {
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-pass').value;
                try {
                    await auth.signInWithEmailAndPassword(email, pass);
                    showToast("Login successful!", "success");
                    // Router handled by auth listener
                } catch (e) {
                    showToast(e.message, "error");
                }
            },

            signupAgent: () => {
                const email = document.getElementById('signup-email').value;
                const pass = document.getElementById('signup-pass').value;
                const name = document.getElementById('signup-name').value;

                if(!email || !pass || !name) return showToast("Please fill all fields", "error");

                // Trigger Paystack
                const handler = PaystackPop.setup({
                    key: CONFIG.paystackKey,
                    email: email,
                    amount: CONFIG.agentFee * 100, // In pesewas
                    currency: CONFIG.currency,
                    callback: async (response) => {
                        showToast("Payment successful. Creating account...", "success");
                        try {
                            const cred = await auth.createUserWithEmailAndPassword(email, pass);
                            // Create Agent Profile
                            await db.collection("users").doc(cred.user.uid).set({
                                name: name,
                                email: email,
                                role: 'agent',
                                agentCode: Math.random().toString(36).substring(2, 8).toUpperCase(),
                                balance: 0,
                                commission: 10, // Default 10% or fixed amount logic
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            app.router('dashboard');
                        } catch (e) {
                            showToast("Account creation failed: " + e.message, "error");
                        }
                    },
                    onClose: () => showToast("Payment cancelled", "error")
                });
                handler.openIframe();
            },

            initiatePurchase: (prodId, prodName, price) => {
                const email = prompt("Enter email for receipt:"); // In a real app, use a nice modal
                if(!email) return;

                const refCode = localStorage.getItem("dataplus_agent_ref");

                const handler = PaystackPop.setup({
                    key: CONFIG.paystackKey,
                    email: email,
                    amount: price * 100,
                    currency: CONFIG.currency,
                    metadata: {
                        custom_fields: [
                            { display_name: "Product", variable_name: "product", value: prodName }
                        ]
                    },
                    callback: async (response) => {
                        showToast("Payment Successful! Processing...", "success");
                        
                        // Record Order
                        const orderData = {
                            product: prodName,
                            price: price,
                            status: "PAID",
                            customerEmail: email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        // If Referred, add agent info
                        if (refCode) {
                            // Find agent by code
                            const agentSnap = await db.collection("users").where("agentCode", "==", refCode).limit(1).get();
                            if (!agentSnap.empty) {
                                const agentDoc = agentSnap.docs[0];
                                orderData.agentId = agentDoc.id;
                                
                                // Calculate Commission (Simple 10% logic for demo)
                                const commission = price * 0.10; 
                                
                                // Update Agent Balance (Client side is insecure for real apps, use Cloud Functions for production)
                                db.collection("users").doc(agentDoc.id).update({
                                    balance: firebase.firestore.FieldValue.increment(commission)
                                });
                            }
                        }

                        await db.collection("orders").add(orderData);
                        showToast("Order placed successfully!", "success");
                    }
                });
                handler.openIframe();
            },

            copyLink: (code) => {
                const url = `${window.location.origin}?ref=${code}`;
                navigator.clipboard.writeText(url).then(() => {
                    showToast("Link copied to clipboard!", "success");
                });
            },

            requestWithdrawal: async (currentBalance) => {
                if(currentBalance < 10) return showToast("Minimum withdrawal is GHS 10", "error");
                
                const amount = parseFloat(prompt("Enter amount to withdraw:"));
                if(!amount || amount > currentBalance) return showToast("Invalid amount", "error");

                try {
                    // Deduct balance immediately (Optimistic UI)
                    await db.collection("users").doc(state.user.uid).update({
                        balance: firebase.firestore.FieldValue.increment(-amount)
                    });

                    await db.collection("withdrawals").add({
                        agentId: state.user.uid,
                        amount: amount,
                        status: "pending",
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showToast("Withdrawal requested.", "success");
                    app.router('dashboard'); // Refresh UI
                } catch(e) {
                    showToast("Error: " + e.message, "error");
                }
            },

            // --- ADMIN ACTIONS ---
            adminAddProduct: async () => {
                const name = document.getElementById("new-prod-name").value;
                const price = parseFloat(document.getElementById("new-prod-price").value);
                if(!name || !price) return;

                await db.collection("products").add({
                    name, price, active: true
                });
                showToast("Product added", "success");
                app.fetchProducts().then(() => views.renderAdmin(document.getElementById('app-root')));
            },

            adminDeleteProduct: async (id) => {
                if(confirm("Delete this product?")) {
                    await db.collection("products").doc(id).delete();
                    showToast("Product deleted", "success");
                    app.fetchProducts().then(() => views.renderAdmin(document.getElementById('app-root')));
                }
            },

            adminApproveWithdrawal: async (docId, agentId, amount) => {
                if(confirm(`Mark GHS ${amount} as PAID to agent?`)) {
                    await db.collection("withdrawals").doc(docId).update({
                        status: "paid",
                        processedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast("Withdrawal marked as paid", "success");
                    views.renderAdmin(document.getElementById('app-root'));
                }
            }
        };

        // --- UTILS ---
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
            menu.classList.toggle('flex');
        }

        function showToast(message, type = "info") {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                info: 'bg-blue-600'
            };

            toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-xl animate-fade-in flex items-center gap-3 min-w-[300px]`;
            toast.innerHTML = `
                <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-triangle-exclamation' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;

            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // --- START APP ---
        window.addEventListener('DOMContentLoaded', app.init);

    </script>
</body>
    </html>
